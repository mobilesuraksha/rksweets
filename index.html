<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ram Kishan's Sweets - Cloud Manager</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- GENERAL STYLES --- */
        body { font-family: 'Poppins', sans-serif; margin: 0; padding: 0; background-color: #f4f7f6; color: #333; }
        .container { max-width: 1600px; margin: 20px auto; padding: 25px; background-color: #ffffff; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); border-radius: 12px; }
        h1 { color: #2c3e50; font-weight: 700; border-bottom: 3px solid #3498db; padding-bottom: 10px; margin-bottom: 25px; }
        h2 { color: #34495e; font-weight: 600; margin-top: 0; margin-bottom: 20px; border-left: 5px solid #3498db; padding-left: 10px; }

        /* --- LOGIN OVERLAY --- */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(44, 62, 80, 0.95); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
        }
        .login-box {
            background: white; padding: 40px; border-radius: 10px; width: 350px; text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .login-box input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        
        /* --- TABS --- */
        .tab-menu { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 25px; border-bottom: 2px solid #e0e0e0; }
        .tab-button {
            background-color: #f1f1f1; border: none; outline: none; cursor: pointer; padding: 12px 20px;
            transition: 0.3s; font-size: 14px; font-weight: 600; color: #555; border-radius: 5px 5px 0 0; flex-grow: 1; text-align: center;
        }
        .tab-button:hover { background-color: #ddd; color: #000; }
        .tab-button.active { background-color: #3498db; color: white; }
        
        /* Tab Colors */
        .tab-button[onclick*="productionTab"] { background-color: #fff3e0; color: #d35400; }
        .tab-button[onclick*="productionTab"].active { background-color: #d35400; color: white; }
        .tab-button[onclick*="packingTab"] { background-color: #e8f5e9; color: #2e7d32; }
        .tab-button[onclick*="packingTab"].active { background-color: #2e7d32; color: white; }
        .tab-button[onclick*="monthReport"] { background-color: #e0f7fa; color: #006064; }
        .tab-button[onclick*="monthReport"].active { background-color: #006064; color: white; }
        .tab-button[onclick*="reportsTab"] { background-color: #f3e5f5; color: #6a1b9a; }
        .tab-button[onclick*="reportsTab"].active { background-color: #6a1b9a; color: white; }

        .tab-content { display: none; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- FORMS & INPUTS --- */
        .form-row { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px; }
        .form-group { flex: 1; min-width: 150px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 13px; color: #666; }
        input, select, textarea {
            width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box;
            font-family: inherit; font-size: 14px; transition: border 0.3s;
        }
        input:focus, select:focus { border-color: #3498db; outline: none; box-shadow: 0 0 5px rgba(52,152,219,0.3); }

        /* --- ADMIN CARDS --- */
        .admin-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px; }
        .admin-card {
            background: white; border-radius: 10px; padding: 25px; text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); transition: transform 0.2s; border-top: 4px solid #ccc;
        }
        .admin-card:hover { transform: translateY(-5px); }
        .admin-card h3 { margin: 10px 0; font-size: 18px; color: #444; }
        .admin-card p { color: #777; font-size: 12px; margin-bottom: 20px; height: 30px; }
        .stat-badge { background: #eee; padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .icon-large { font-size: 40px; margin-bottom: 10px; display: block; }

        /* --- BOX GROUP STYLING --- */
        .box-group-container {
            border: 2px solid #3498db; background-color: #f0f8ff; border-radius: 8px; padding: 15px; margin-bottom: 20px; position: relative;
        }
        .box-group-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #b3e5fc; }
        .box-group-title { font-weight: 700; color: #2980b9; font-size: 16px; }
        .item-list-container { background-color: white; padding: 10px; border-radius: 6px; border: 1px solid #ddd; }
        .item-row { display: flex; gap: 10px; align-items: flex-end; margin-bottom: 8px; border-bottom: 1px dashed #eee; padding-bottom: 8px; }
        
        #subTotal, #totalAmount, #balanceShow { background-color: #eaf2f8; color: #2980b9; font-weight: 700; cursor: not-allowed; }
        #totalAmount { background-color: #d1f2eb; color: #27ae60; font-size: 16px; border: 2px solid #27ae60; }
        #balanceShow { background-color: #fef9e7; color: #d35400; }

        /* Buttons */
        .btn { padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; font-size: 13px; }
        .btn-success { background-color: #27ae60; color: white; width: 100%; margin-top: 10px; font-size: 16px; padding:12px; }
        .btn-primary { background-color: #3498db; color: white; }
        .btn-warning { background-color: #f39c12; color: white; }
        .btn-danger { background-color: #e74c3c; color: white; }
        .btn-logout { background-color: #34495e; color: white; float: right; margin-top: -60px; }
        .btn-sm { padding: 5px 10px; font-size: 12px; }

        /* Tables */
        .table-responsive { overflow-x: auto; margin-top: 20px; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 12px; background-color: white; table-layout: fixed; }
        .data-table th, .data-table td { padding: 6px 8px; border: 1px solid #eee; text-align: left; vertical-align: top; word-wrap: break-word;}
        .data-table th { background-color: #f2f2f2; color: #333; font-weight: 600; }
        
        /* Summary Dashboard */
        #summaryDashboard, #monthDashboard { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .summary-card { 
            flex: 1; min-width: 160px; padding: 15px; border-radius: 8px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-left: 5px solid #ccc; background-color: white; 
            display: flex; flex-direction: column; justify-content: center;
        }
        .summary-card h4 { margin: 0 0 5px 0; font-size: 12px; color: #555; text-transform: uppercase; letter-spacing: 0.5px; }
        .summary-card .value { font-size: 20px; font-weight: 700; color: #333; }

        /* Stacked Payment Badges with Actions */
        .mode-badge {
            display: block; width: 100%; padding: 4px 8px; border-radius: 6px; font-size: 12px; margin-bottom: 5px;
            box-sizing: border-box; border-left-width: 4px !important; position: relative;
        }
        .badge-actions { float: right; }
        .btn-icon { background: none; border: none; cursor: pointer; font-size: 14px; padding: 0 2px; margin-left: 3px; font-weight: bold; }
        .btn-icon:hover { opacity: 0.7; }
        .icon-edit { color: #2980b9; }
        .icon-del { color: #c0392b; }

        /* Pay History Items */
        .pay-history-item { font-size: 11px; color: #666; border-bottom: 1px solid #f0f0f0; padding: 3px 0; display: flex; justify-content: space-between; }
        .pay-history-item:last-child { border-bottom: none; }

        /* Ledger Summary Bar */
        .ledger-summary-grid { display: flex; justify-content: flex-end; gap: 15px; margin-top: 20px; border-top: 2px solid #eee; padding-top: 15px; }
        .ls-item { flex: 0 0 auto; min-width: 180px; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); background-color: white; border-left: 5px solid #ccc; }
        .ls-item h4 { margin: 0 0 5px 0; font-size: 12px; color: #666; text-transform: uppercase; }
        .ls-item .value { font-size: 20px; font-weight: 700; color: #333; }
        .ls-item.debit { border-left-color: #2196f3; background-color: #e3f2fd; } 
        .ls-item.credit { border-left-color: #4caf50; background-color: #e8f5e9; } 
        .ls-item.balance { border-left-color: #f44336; background-color: #ffebee; }

        /* --- PRINT STYLES --- */
        .ledger-print-head { display: none; }
        .print-header-date { display: none; }
        .print-footer { display: none; }

        @media print {
            @page { size: A4 portrait; margin: 10mm; }
            body { background-color: white; font-size: 12px; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            .container { box-shadow: none; margin: 0; padding: 0; max-width: 100%; width: 100%; border: none; }
            .tab-menu, .btn, .filter-controls-screen, h1, #reportsTab, .badge-actions { display: none !important; }
            .tab-content { display: none; }
            .tab-content.active-print { display: block !important; }
            .data-table { font-size: 10px; width: 100%; border: 1px solid #000; }
            .data-table th, .data-table td { border: 1px solid #000 !important; color: black; padding: 4px !important; }
            .data-table th { background-color: #eee !important; font-weight: bold; }
            .print-header-date { display: block !important; font-size: 14px; font-weight: bold; margin-bottom: 10px; text-decoration: underline; }
            h2 { font-size: 16px !important; margin: 5px 0 10px 0 !important; border: none !important; padding: 0 !important; text-align: center; text-transform: uppercase; }
            .print-footer { display: flex !important; justify-content: space-between; margin-top: 40px; padding-top: 10px; }
            .print-footer span { border-top: 1px solid #000; padding-top: 5px; width: 200px; text-align: center; font-weight: bold; }
            
            #ledgerTab .ledger-print-head { display: block !important; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 10px; }
            #ledgerTab h2 { display: none; }
            .lp-company-name { font-size: 26px; font-weight: 800; text-align: center; margin: 0; color: #000; letter-spacing: 1px; }
            .lp-subtitle { text-align: center; font-size: 12px; margin: 2px 0 15px 0; text-transform: uppercase; letter-spacing: 2px; border-bottom: 1px solid #ccc; padding-bottom: 5px; width: 50%; margin: 0 auto; }
            .ledger-info-grid { display: flex; justify-content: space-between; margin-top: 20px; border: 1px solid #000; padding: 10px; background-color: #f9f9f9 !important; }
            .ledger-box { width: 48%; }
            .ledger-box strong { display: block; font-size: 13px; margin-bottom: 5px; text-decoration: underline; }
            #ledgerTab .data-table th { background-color: #333 !important; color: white !important; }
            .ledger-summary-grid { border-top: 2px solid #000; margin-top: 10px; justify-content: flex-end; gap: 10px; }
            .ls-item { border: 1px solid #000; background: white !important; min-width: 120px; padding: 5px 10px; box-shadow: none; border-radius: 0; }
            .ls-item h4 { font-size: 10px; margin-bottom: 2px; }
            .ls-item .value { font-size: 14px; }
            #summaryDashboard, #monthDashboard { gap: 5px; margin-bottom: 10px; }
            .summary-card { padding: 5px; border: 1px solid #999 !important; box-shadow: none !important; min-width: 80px; }
        }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal-content { background: white; margin: 10% auto; padding: 25px; width: 90%; max-width: 400px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-box">
        <h2 style="color:#3498db; border-bottom:2px solid #3498db; padding-bottom:10px;">SECURE LOGIN</h2>
        <p>Ram Kishan's Sweets</p>
        <input type="email" id="loginEmail" placeholder="Enter Email" value="">
        <input type="password" id="loginPass" placeholder="Enter Password" value="">
        <button class="btn btn-primary" style="width:100%; font-size:16px;" onclick="window.appLogin()">Login System</button>
        <p id="loginMsg" style="color:red; font-size:12px; margin-top:10px;"></p>
    </div>
</div>

<div class="container" id="mainApp" style="display:none;">
    <h1>Ram Kishan's Sweets - Cloud Manager</h1>
    <button class="btn btn-logout" onclick="window.appLogout()">Logout üîí</button>

    <div class="tab-menu">
        <button class="tab-button active" onclick="window.openTab('addOrder', this)">New Order</button>
        <button class="tab-button" onclick="window.openTab('productionTab', this)">Production</button>
        <button class="tab-button" onclick="window.openTab('packingTab', this)">Packing</button>
        <button class="tab-button" onclick="window.openTab('todaySummary', this)">Today's Summary</button>
        <button class="tab-button" onclick="window.openTab('monthReport', this)">Monthly Report</button>
        <button class="tab-button" onclick="window.openTab('duePayments', this)">Due Payments</button>
        <button class="tab-button" onclick="window.openTab('allOrders', this)">All Orders</button>
        <button class="tab-button" onclick="window.openTab('ledgerTab', this)">Customer Ledger</button>
        <button class="tab-button" onclick="window.openTab('expensesTab', this)">Expenses</button>
        <button class="tab-button" onclick="window.openTab('reportsTab', this)">System Admin</button>
    </div>

    <div id="addOrder" class="tab-content active-print" style="display: block;">
        <h2>Create New Order</h2>
        <form id="orderForm">
            <input type="hidden" id="orderId">
            <div class="form-row">
                <div class="form-group"><label>Order No.</label><input type="text" id="orderNo" list="orderNoList" autocomplete="off" required></div>
                <datalist id="orderNoList"></datalist>

                <div class="form-group"><label>Date</label><input type="date" id="orderDate" required></div>
                <div class="form-group"><label>Delivery Date</label><input type="date" id="deliveryDate" required></div>
                <div class="form-group"><label>Delivery Time</label><input type="time" id="deliveryTime"></div>
            </div>
            <div class="form-row">
                <div class="form-group" style="flex: 2;"><label>Customer Name</label><input type="text" id="customerName" list="custList" autocomplete="off" required></div>
                <datalist id="custList"></datalist>

                <div class="form-group"><label>Mobile</label><input type="tel" id="mobile"></div>
                <div class="form-group">
                    <label>Order Type</label>
                    <select id="orderType">
                        <option value="REGULAR">Regular</option>
                        <option value="BHAJI">Bhaji</option>
                        <option value="SNACKS">Snacks</option>
                        <option value="DIWALI">Diwali</option>
                        <option value="CUSTOM">Custom</option>
                    </select>
                </div>
            </div>

            <h3>üì¶ Box Configurations</h3>
            <div id="boxContainer"></div>
            <button type="button" class="btn btn-primary" onclick="window.addBoxGroup()">+ Add New Box Group</button>
            <hr>

            <div class="form-row" style="margin-top: 20px; align-items: flex-end;">
                <div class="form-group">
                    <label>Sub Total</label>
                    <input type="number" id="subTotal" readonly>
                </div>
                <div class="form-group">
                    <label style="color:#c0392b;">Discount</label>
                    <input type="number" id="discount" value="0" oninput="window.calculateGrandTotal()">
                </div>
                <div class="form-group">
                    <label style="color:#27ae60; font-weight:bold;">Net Amount</label>
                    <input type="number" id="totalAmount" readonly>
                </div>
            </div>

            <div class="form-row" style="margin-top: 10px; align-items: flex-end;">
                <div class="form-group"><label>Advance Paid</label><input type="number" id="advancePaid" value="0" step="0.01" oninput="window.calculateGrandTotal()"></div>
                <div class="form-group">
                    <label style="color:#d35400;">Payment Date</label>
                    <input type="date" id="advanceDate" style="border:1px solid #d35400;">
                </div>
                <div class="form-group">
                    <label>Payment Mode</label>
                    <select id="paymentMode" class="payment-select"></select>
                </div>
                <div class="form-group"><label>Balance Due</label><input type="number" id="balanceShow" readonly></div>
            </div>
            
            <div class="form-row">
                <div class="form-group"><label>Order Note</label><input type="text" id="orderRemark" placeholder="Special Instructions..."></div>
            </div>

            <button type="submit" class="btn btn-success">Save Order (Cloud)</button>
        </form>
    </div>

    <div id="productionTab" class="tab-content">
        <h2>Kitchen / Production List</h2>
        <div class="print-header-date" id="printDateProd"></div>
        <div class="form-row filter-controls-screen">
            <div class="form-group"><label>Delivery Date</label><input type="date" id="prodDateFilter" onchange="window.renderProduction()"></div>
            <div class="form-group"><label>Search Item</label><input type="text" id="prodSearchFilter" placeholder="Search..." oninput="window.renderProduction()"></div>
            <div class="form-group"><label style="color:#d35400; font-weight:bold;">Report Prepared By*</label><input type="text" id="prodSignInput" placeholder="Name..." oninput="window.updateSign('prodSignInput','prodSignDisplay')"></div>
            <div class="form-group" style="align-self: flex-end;"><button class="btn btn-primary" onclick="window.checkSignAndPrint('prodSignInput')">Print List</button></div>
        </div>
        <div class="table-responsive">
            <table class="data-table" id="productionTable">
                <thead><tr><th style="width:40%">Item Name</th><th style="width:20%">Total Quantity</th><th style="width:40%">Remarks</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="print-footer">
            <span>Prepared By: <b id="prodSignDisplay"></b></span>
            <span>Manager Check</span>
        </div>
    </div>

    <div id="packingTab" class="tab-content">
        <h2>Packing & Dispatch</h2>
        <div class="print-header-date" id="printDatePack"></div>
        <div class="form-row filter-controls-screen">
            <div class="form-group"><label>Delivery Date</label><input type="date" id="packDateFilter" onchange="window.renderPacking()"></div>
            <div class="form-group"><label>Search</label><input type="text" id="packSearchFilter" placeholder="Search..." oninput="window.renderPacking()"></div>
            <div class="form-group"><label style="color:#d35400; font-weight:bold;">Checked By*</label><input type="text" id="packSignInput" placeholder="Name..." oninput="window.updateSign('packSignInput','packSignDisplay')"></div>
            <div class="form-group" style="align-self: flex-end;"><button class="btn btn-primary" onclick="window.checkSignAndPrint('packSignInput')">Print List</button></div>
        </div>
        <div class="table-responsive">
            <table class="data-table" id="packingTable">
                <thead><tr><th style="width:12%">Time</th><th style="width:25%">Customer</th><th style="width:45%">Details</th><th style="width:18%">Notes</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="print-footer">
            <span>Packed By: <b id="packSignDisplay"></b></span>
            <span>Dispatched By</span>
        </div>
    </div>

    <div id="todaySummary" class="tab-content">
        <h2>Daily Summary Report</h2>
        <div class="print-header-date" id="printDateSum"></div>
        <div class="form-row filter-controls-screen">
            <div class="form-group"><label>Select Report Date</label><input type="date" id="summaryDateFilter" onchange="window.renderSummary()"></div>
            <div class="form-group"><label style="color:#d35400; font-weight:bold;">Report By*</label><input type="text" id="sumSignInput" placeholder="Name..." oninput="window.updateSign('sumSignInput','sumSignDisplay')"></div>
            <div class="form-group" style="align-self: flex-end;"><button class="btn btn-primary" onclick="window.checkSignAndPrint('sumSignInput')">Print Summary</button></div>
        </div>

        <div id="summaryDashboard"></div>
        
        <table class="data-table" id="summaryTable">
            <thead>
                <tr>
                    <th style="width:8%">Order</th>
                    <th style="width:10%">Del. Date</th>
                    <th style="width:15%">Customer</th>
                    <th style="width:25%">Box Details</th>
                    <th style="width:12%">Bill Amount</th>
                    <th style="width:20%">Paid Details (Hist)</th>
                    <th style="width:10%">Due</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <h3 style="margin-top:30px; border-left:5px solid #c62828; padding-left:10px; color:#c0392b;">Today's Expenses</h3>
        <table class="data-table" id="summaryExpenseTable">
            <thead>
                <tr>
                    <th style="width:50%">Expense Detail</th>
                    <th style="width:25%">Mode</th>
                    <th style="width:25%">Amount</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        
        <div class="print-footer">
            <span>Generated By: <b id="sumSignDisplay"></b></span>
            <span>Owner Sign</span>
        </div>
    </div>

    <div id="monthReport" class="tab-content">
        <h2>Monthly Reports</h2>
        <div class="print-header-date" id="printDateMonth"></div>
        <div class="form-row filter-controls-screen">
            <div class="form-group">
                <label>Select Month</label>
                <input type="month" id="monthInput" onchange="window.renderMonthReports()">
            </div>
            <div class="form-group" style="align-self: flex-end;">
                <button class="btn btn-warning" onclick="window.openIncomeModal()">+ Add Daily Income (Rest/Showroom)</button>
                <button class="btn btn-primary" onclick="window.print()">Print Report</button>
            </div>
        </div>

        <div id="monthDashboard"></div>

        <h3 style="margin-top:20px;">Daily Breakdown</h3>
        <table class="data-table" id="monthTable">
            <thead>
                <tr>
                    <th style="width:10%">Date</th>
                    <th style="width:5%">Ord</th>
                    <th style="width:10%; text-align:right;">Sweets</th>
                    <th style="width:10%; text-align:right; color:#d35400;">Rest. Cash</th>
                    <th style="width:10%; text-align:right; color:#e67e22;">Rest. UPI</th>
                    <th style="width:10%; text-align:right; color:#8e44ad;">Show. Cash</th>
                    <th style="width:10%; text-align:right; color:#9b59b6;">Show. UPI</th>
                    <th style="width:10%; text-align:right; color:#27ae60; font-weight:bold;">Total Inc.</th>
                    <th style="width:10%; text-align:right; color:#c0392b;">Exp</th>
                    <th style="width:10%; text-align:right;">Net Profit</th>
                </tr>
            </thead>
            <tbody id="monthTableBody"></tbody>
        </table>

        <h3 style="margin-top:30px; border-left:5px solid #f39c12; padding-left:10px;">Restaurant & Showroom Income Log</h3>
        <table class="data-table" id="otherIncomeTable">
            <thead><tr><th>Date</th><th>Source</th><th>Amount</th><th>Mode</th><th class="filter-controls-screen">Action</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="duePayments" class="tab-content">
        <h2>Due Payments</h2>
        <div class="form-row filter-controls-screen" style="background:#fff3e0; padding:10px; border-radius:8px;">
             <div class="form-group">
                <label>Filter by Order Date (Optional)</label>
                <input type="date" id="dueDetailDate" onchange="window.renderDuePayments()">
             </div>
             <div class="form-group">
                <label>Search</label>
                <input type="text" id="dueSearchInput" placeholder="Name or Order No..." oninput="window.renderDuePayments()">
             </div>
             <div class="form-group" style="align-self: flex-end;">
                 <button class="btn btn-primary" onclick="window.renderDuePayments()">Refresh</button>
                 <button class="btn btn-warning" onclick="window.print()">Print List</button>
             </div>
        </div>
        <table class="data-table" id="dueTable" style="margin-top:10px;">
            <thead><tr><th>Date</th><th>Order</th><th>Customer</th><th>Total</th><th>Paid</th><th>Due</th><th class="filter-controls-screen">Action</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="allOrders" class="tab-content">
        <h2>All Orders</h2>
        <div class="form-row filter-controls-screen" style="background:#e3f2fd; padding:10px; border-radius:8px;">
            <div class="form-group"><label>From Date</label><input type="date" id="searchFromDate" onchange="window.renderAllOrders()"></div>
            <div class="form-group"><label>To Date</label><input type="date" id="searchToDate" onchange="window.renderAllOrders()"></div>
            <div class="form-group"><label>Search Order</label><input type="text" id="searchOrder" placeholder="Search..." oninput="window.renderAllOrders()"></div>
        </div>
        <table class="data-table" id="allOrdersTable">
            <thead><tr><th>Date</th><th>Order</th><th>Customer</th><th>Box Summary</th><th>Amount</th><th class="filter-controls-screen">Action</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="ledgerTab" class="tab-content">
        <div class="ledger-print-head">
            <h1 class="lp-company-name">RAM KISHAN'S SWEETS</h1>
            <p class="lp-subtitle">Statement of Account</p>
            <div class="ledger-info-grid">
                <div class="ledger-box">
                    <strong>Bill To:</strong>
                    <span id="printLedgerCustName" style="font-size:16px; text-transform:uppercase;"></span><br>
                    <span id="printLedgerMobile"></span>
                </div>
                <div class="ledger-box" style="text-align:right;">
                    <strong>Details:</strong>
                    Date: <span id="printLedgerDate"></span>
                </div>
            </div>
        </div>

        <h2>Customer Ledger</h2>
        <div class="form-row filter-controls-screen">
            <div class="form-group">
                <label>Select Customer</label>
                <select id="ledgerCustomerSelect" onchange="window.renderLedger()">
                    <option value="">-- Select Customer --</option>
                </select>
            </div>
            <div class="form-group" style="align-self: flex-end;">
                <button class="btn btn-primary" onclick="window.print()">Print Formal Statement</button>
            </div>
        </div>
        <div id="ledgerContent" style="display:none;">
            <div class="table-responsive">
                <table class="data-table" id="ledgerTable">
                    <thead>
                        <tr>
                            <th style="width:15%">Date</th>
                            <th style="width:40%">Description</th>
                            <th style="width:15%; text-align:right;">Debit</th>
                            <th style="width:15%; text-align:right;">Credit</th>
                            <th style="width:15%; text-align:right;">Balance</th>
                            <th class="filter-controls-screen" style="width:10%">Action</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="ledger-summary-grid">
                <div class="ls-item debit"><h4>Total Bill</h4><div class="value" id="ledgerTotalDebit"></div></div>
                <div class="ls-item credit"><h4>Total Paid</h4><div class="value" id="ledgerTotalCredit"></div></div>
                <div class="ls-item balance"><h4>Net Balance Due</h4><div class="value" id="ledgerBalance"></div></div>
            </div>
            <div class="print-footer">
                <span>Customer Sign</span>
                <span>Authorized Signatory</span>
            </div>
        </div>
    </div>

    <div id="expensesTab" class="tab-content">
        <h2>Expense Management</h2>
        <div class="form-row filter-controls-screen" style="background:#fff0f0; padding:15px; border-radius:8px; border:1px solid #ffcccc;">
            <div class="form-group"><label>Date</label><input type="date" id="expDate"></div>
            <div class="form-group"><label>Amount</label><input type="number" id="expAmt"></div>
            <div class="form-group">
                <label>Payment Mode</label>
                <select id="expMode" class="payment-select"></select>
            </div>
            <div class="form-group"><label>Details</label><input type="text" id="expDetail" placeholder="Rent, Salary, etc"></div>
            <div class="form-group" style="align-self: flex-end;">
                <button class="btn btn-danger" onclick="window.addExpense()">Add Expense (Cloud)</button>
            </div>
        </div>
        <div class="table-responsive">
            <table class="data-table" id="expenseTable">
                <thead><tr><th>Date</th><th>Detail</th><th>Amount</th><th>Mode</th><th class="filter-controls-screen">Action</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="reportsTab" class="tab-content">
        <h2>System Administration</h2>
        <div class="admin-grid">
            <div class="admin-card" style="border-top-color: #f39c12;">
                <span class="icon-large">üìÇ</span>
                <h3>Backup Data (Export)</h3>
                <p>Download all cloud data to your PC.</p>
                <button class="btn btn-warning" onclick="window.exportData()">Download Backup (Password)</button>
            </div>

            <div class="admin-card" style="border-top-color: #3498db;">
                <span class="icon-large">üì•</span>
                <h3>Restore Data (Import)</h3>
                <p>Load data from a backup file to Cloud.</p>
                <button class="btn btn-primary" onclick="window.checkPassAndImport()">Restore Backup (Password)</button>
                <input type="file" id="importFile" style="display:none" onchange="window.importData(this)">
            </div>

            <div class="admin-card" style="border-top-color: #27ae60;">
                <span class="icon-large">üìä</span>
                <h3>Cloud Status</h3>
                <p>Status of your current database.</p>
                <div style="text-align:left; padding:0 15px;">
                    <div style="margin-bottom:5px;">Orders: <span class="stat-badge" id="statOrders">0</span></div>
                    <div>Ledger Entries: <span class="stat-badge" id="statLedger">0</span></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="payModal" class="modal">
    <div class="modal-content">
        <h3>Add Payment</h3>
        <input type="hidden" id="modalOrderId">
        <label>Date</label><input type="date" id="modalPayDate" style="margin-bottom:10px;">
        <label>Amount</label><input type="number" id="modalPayAmt" placeholder="Amount" style="margin-bottom:10px;">
        <label>Discount (Optional)</label><input type="number" id="modalDiscount" placeholder="Discount" style="margin-bottom:10px;">
        <label>Mode</label><select id="modalPayMode" class="payment-select" style="margin-bottom:10px;"></select>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="btn btn-success" style="flex:1" onclick="window.savePayment()">Save</button>
            <button class="btn btn-danger" style="flex:1" onclick="document.getElementById('payModal').style.display='none'">Cancel</button>
        </div>
    </div>
</div>

<div id="editPayModal" class="modal">
    <div class="modal-content">
        <h3>Edit Payment</h3>
        <input type="hidden" id="editPayId">
        <label>Date</label><input type="date" id="editPayDate" style="margin-bottom:10px;">
        <label>Amount</label><input type="number" id="editPayAmt" style="margin-bottom:10px;">
        <label>Mode</label><select id="editPayMode" class="payment-select" style="margin-bottom:10px;"></select>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="btn btn-primary" style="flex:1" onclick="window.saveEditedPayment()">Update</button>
            <button class="btn btn-danger" style="flex:1" onclick="document.getElementById('editPayModal').style.display='none'">Cancel</button>
        </div>
    </div>
</div>

<div id="incomeModal" class="modal">
    <div class="modal-content">
        <h3 id="incModalTitle">Add Other Daily Income</h3>
        <input type="hidden" id="incId"> <label>Date</label>
        <input type="date" id="incDate" style="margin-bottom:10px;">
        
        <label>Source</label>
        <select id="incSource" style="margin-bottom:10px;">
            <option value="Restaurant">Restaurant Sale</option>
            <option value="Showroom">Showroom Sale</option>
        </select>

        <label>Amount</label>
        <input type="number" id="incAmt" placeholder="Total Sale Amount" style="margin-bottom:10px;">
        
        <label>Mode</label>
        <select id="incMode" style="margin-bottom:10px;">
            <option value="Cash">Cash</option>
            <option value="UPI">UPI (Online)</option>
            <option value="Card">Card</option>
            <option value="Bank Transfer">Bank Transfer</option>
        </select>
        
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button id="incSaveBtn" class="btn btn-success" style="flex:1" onclick="window.saveOtherIncome()">Save Income</button>
            <button class="btn btn-danger" style="flex:1" onclick="document.getElementById('incomeModal').style.display='none'">Cancel</button>
        </div>
    </div>
</div>

<script type="module">
  // --- üîí KILL SWITCH START üîí ---
  if (window.location.protocol === "file:") {
      localStorage.clear();
      sessionStorage.clear();
      document.body.innerHTML = `
          <div style="display:flex; justify-content:center; align-items:center; height:100vh; flex-direction:column; font-family:sans-serif; background:#f5f5f5;">
              <h1 style="color:#555;">Cloud Access Only</h1>
              <p>Security Restriction: Data cannot be loaded from local files.</p>
              <p>Please open the official website link.</p>
          </div>
      `;
      throw new Error("Execution stopped: Local file access detected.");
  }
  // --- KILL SWITCH END ---

  // --- FIREBASE SETUP ---
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
  import { getFirestore, collection, addDoc, doc, setDoc, deleteDoc, onSnapshot, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
  import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCn_9Z8oEnK03gtfC_EC-z4cONx5lMddes",
    authDomain: "ramkishan-a2c11.firebaseapp.com",
    projectId: "ramkishan-a2c11",
    storageBucket: "ramkishan-a2c11.firebasestorage.app",
    messagingSenderId: "512484078712",
    appId: "1:512484078712:web:d8f3470bd22dd37f63e98d"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // --- GLOBAL DATA ---
  let globalOrders = [];
  let globalLedger = [];

  // --- AUTH ---
  window.appLogin = async () => {
      const email = document.getElementById('loginEmail').value;
      const pass = document.getElementById('loginPass').value;
      const msg = document.getElementById('loginMsg');
      try {
          msg.textContent = "Logging in...";
          await signInWithEmailAndPassword(auth, email, pass);
          msg.textContent = "";
      } catch (error) {
          msg.textContent = "Error: " + error.message;
      }
  };

  window.appLogout = () => {
      signOut(auth).then(() => {
          location.reload();
      });
  };

  onAuthStateChanged(auth, (user) => {
      if (user) {
          document.getElementById('loginOverlay').style.display = 'none';
          document.getElementById('mainApp').style.display = 'block';
          startDataSync(); 
      } else {
          document.getElementById('loginOverlay').style.display = 'flex';
          document.getElementById('mainApp').style.display = 'none';
      }
  });

  // --- REAL-TIME SYNC (FIXED: Added populateLedgerSelect calls) ---
  function startDataSync() {
      onSnapshot(collection(db, "orders"), (snapshot) => {
          globalOrders = snapshot.docs.map(doc => doc.data());
          updateSuggestions();
          window.populateLedgerSelect(); // Fix: Update ledger list
          refreshCurrentTab();
          updateStats();
      });
      onSnapshot(collection(db, "ledger"), (snapshot) => {
          globalLedger = snapshot.docs.map(doc => doc.data());
          window.populateLedgerSelect(); // Fix: Update ledger list
          refreshCurrentTab();
          updateStats();
      });
  }
  
  function updateSuggestions() {
      const orderList = document.getElementById('orderNoList');
      const custList = document.getElementById('custList');
      
      const uniqueOrders = [...new Set(globalOrders.map(o => o.no))];
      const uniqueCust = [...new Set(globalOrders.map(o => o.cust))];

      orderList.innerHTML = uniqueOrders.map(o => `<option value="${o}">`).join('');
      custList.innerHTML = uniqueCust.map(c => `<option value="${c}">`).join('');
  }

  function updateStats() {
      document.getElementById('statOrders').innerText = globalOrders.length;
      document.getElementById('statLedger').innerText = globalLedger.length;
  }

  function refreshCurrentTab() {
      if(document.getElementById('productionTab').style.display === 'block') window.renderProduction();
      if(document.getElementById('packingTab').style.display === 'block') window.renderPacking();
      if(document.getElementById('todaySummary').style.display === 'block') window.renderSummary();
      if(document.getElementById('monthReport').style.display === 'block') window.renderMonthReports();
      if(document.getElementById('duePayments').style.display === 'block') window.renderDuePayments();
      if(document.getElementById('allOrders').style.display === 'block') window.renderAllOrders();
      if(document.getElementById('ledgerTab').style.display === 'block') window.renderLedger();
      if(document.getElementById('expensesTab').style.display === 'block') window.renderExpenses();
  }

  // --- HELPER FUNCTIONS ---
  const today = new Date().toISOString().split('T')[0];
  const genId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);

  window.formatAMPM = (time) => {
      if (!time) return '--';
      let [hours, minutes] = time.split(':');
      hours = parseInt(hours);
      const ampm = hours >= 12 ? 'PM' : 'AM';
      hours = hours % 12;
      hours = hours ? hours : 12; 
      return `${hours}:${minutes} ${ampm}`;
  }

  window.formatMoney = (amount) => '‚Çπ' + parseFloat(amount).toFixed(2);
   
  window.formatDate = (dateStr) => {
      if(!dateStr) return '';
      const [y, m, d] = dateStr.split('-');
      return `${d}-${m}-${y}`;
  }

  // UPDATED: Added CREDITS styling
  window.getModeBadgeStyle = (mode) => {
      mode = (mode || '').toUpperCase();
      if(mode.includes('DISCOUNT')) return 'background:#fff8e1; color:#f57f17; border:1px solid #ffecb3; border-left-color:#f57f17;';
      if(mode.includes('CASH') || mode.includes('COUNTER')) return 'background:#e8f5e9; color:#2e7d32; border:1px solid #c8e6c9; border-left-color:#2e7d32;'; 
      if(mode.includes('UPI') || mode.includes('PAYTM') || mode.includes('GPAY') || mode.includes('ONLINE')) return 'background:#e3f2fd; color:#1565c0; border:1px solid #bbdefb; border-left-color:#1565c0;'; 
      if(mode.includes('CREDIT')) return 'background:#f3e5f5; color:#7b1fa2; border:1px solid #e1bee7; border-left-color:#7b1fa2;'; // New purple style
      return 'background:#f5f5f5; color:#424242; border:1px solid #bdbdbd; border-left-color:#424242;'; 
  }

  // UPDATED: Added CREDITS styling for dashboard card
  window.getCardStyle = (mode) => {
        mode = (mode || '').toUpperCase();
        if(mode.includes('CASH') || mode.includes('COUNTER')) return 'border-left-color: #4caf50; background-color: #e8f5e9; color: #2e7d32;';
        if(mode.includes('UPI') || mode.includes('PAYTM') || mode.includes('ONLINE')) return 'border-left-color: #2196f3; background-color: #e3f2fd; color: #1565c0;';
        if(mode.includes('CARD') || mode.includes('CREDIT')) return 'border-left-color: #9c27b0; background-color: #f3e5f5; color: #7b1fa2;';
        return 'border-left-color: #607d8b; background-color: #eceff1; color: #455a64;';
  }

  window.updateSign = (srcId, destId) => {
      document.getElementById(destId).innerText = document.getElementById(srcId).value;
  }

  window.checkSignAndPrint = (id) => {
      const val = document.getElementById(id).value.trim();
      if(!val) {
          alert("‚ö†Ô∏è STOP: Please enter the Name/Signature first before printing!");
          document.getElementById(id).focus();
          document.getElementById(id).style.border = "2px solid red";
          return;
      }
      document.getElementById(id).style.border = "1px solid #ccc";
      window.print();
  }

  // --- INITIALIZATION ---
  window.onload = function() {
      const selectClasses = document.querySelectorAll('.payment-select');
      const PAYMENT_MODES = ["Cash", "UPI", "Credits", "Counter Pay", "Bank Transfer", "Card", "Cheque", "Other"];
      selectClasses.forEach(sel => {
          sel.innerHTML = '';
          PAYMENT_MODES.forEach(mode => sel.innerHTML += `<option value="${mode}">${mode}</option>`);
      });
      document.querySelectorAll('input[type="date"]').forEach(i => {
          if(!i.id.includes('search') && !i.id.includes('dueDetail')) i.value = today;
      });
      document.getElementById('monthInput').value = new Date().toISOString().slice(0, 7);
      document.getElementById('incDate').value = today; // Set default date for income modal
      window.addBoxGroup(); 
  };

  window.openTab = (id, btn) => {
      document.querySelectorAll('.tab-content').forEach(t => { t.style.display='none'; t.classList.remove('active-print'); });
      document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
      document.getElementById(id).style.display = 'block';
      document.getElementById(id).classList.add('active-print');
      btn.classList.add('active');
      refreshCurrentTab();
  }

  // --- ORDER LOGIC ---
  window.addBoxGroup = (data = {}) => {
      const container = document.getElementById('boxContainer');
      const div = document.createElement('div');
      div.className = 'box-group-container';
      div.innerHTML = `
          <div class="box-group-header">
              <div class="box-group-title">Box Configuration</div>
              <button type="button" class="btn btn-sm btn-danger" onclick="this.closest('.box-group-container').remove(); window.calculateGrandTotal()">Remove</button>
          </div>
          <div class="form-row" style="background: #e1f5fe; padding: 10px; border-radius: 6px;">
              <div class="form-group" style="flex:2"><label>Box Name</label><input type="text" class="group-name" value="${data.groupName || ''}" placeholder="e.g. Mix Box"></div>
              <div class="form-group"><label style="color:#d35400; font-weight:bold;">TOTAL BOXES</label><input type="number" class="group-qty" value="${data.groupQty || 1}" min="1" oninput="window.calculateGrandTotal()" style="border: 2px solid #d35400; font-weight:bold;"></div>
          </div>
          <div class="item-list-container">
              <div class="items-wrapper"></div>
              <button type="button" class="btn btn-sm btn-warning" style="margin-top:5px;" onclick="window.addItemToGroup(this)">+ Add Item</button>
          </div>
      `;
      container.appendChild(div);
      if(data.items && data.items.length > 0) {
          const wrapper = div.querySelector('.items-wrapper');
          data.items.forEach(item => window.addItemToGroup(null, wrapper, item));
      } else {
          window.addItemToGroup(div.querySelector('.btn-warning'));
      }
  }

  window.addItemToGroup = (btn, targetWrapper = null, data = {}) => {
      const wrapper = targetWrapper || btn.previousElementSibling;
      const row = document.createElement('div');
      row.className = 'item-row';
      row.innerHTML = `
          <div style="flex:3;"><label>Item Name</label><input type="text" class="item-name" value="${data.name || ''}" placeholder="Name"></div>
          <div style="flex:1;"><label>Qty</label><input type="number" class="item-qty" value="${data.qty || 1}" step="0.001" oninput="window.calculateGrandTotal()"></div>
          <div style="flex:1;"><label>Rate</label><input type="number" class="item-rate" value="${data.rate || 0}" oninput="window.calculateGrandTotal()"></div>
          <div style="flex:2;"><label>Remark</label><input type="text" class="item-remark" value="${data.remark || ''}" placeholder="Remark"></div>
          <button type="button" class="btn btn-sm btn-danger" onclick="this.parentElement.remove(); window.calculateGrandTotal()">X</button>
      `;
      wrapper.appendChild(row);
  }

  window.calculateGrandTotal = () => {
      let subTotal = 0;
      document.querySelectorAll('.box-group-container').forEach(group => {
          const groupQty = parseFloat(group.querySelector('.group-qty').value) || 0;
          let groupCostPerBox = 0;
          group.querySelectorAll('.item-row').forEach(row => {
              const iQty = parseFloat(row.querySelector('.item-qty').value) || 0;
              const iRate = parseFloat(row.querySelector('.item-rate').value) || 0;
              groupCostPerBox += (iQty * iRate);
          });
          subTotal += (groupCostPerBox * groupQty);
      });
      const discount = parseFloat(document.getElementById('discount').value) || 0;
      const netTotal = subTotal - discount;
      document.getElementById('subTotal').value = subTotal.toFixed(2);
      document.getElementById('totalAmount').value = netTotal.toFixed(2);
      const adv = parseFloat(document.getElementById('advancePaid').value) || 0;
      document.getElementById('balanceShow').value = (netTotal - adv).toFixed(2);
  }

  document.getElementById('orderForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const orderNo = document.getElementById('orderNo').value.trim();
      const existingOrder = globalOrders.find(o => o.no === orderNo);
      let isDuplicateMerge = false;

      if(existingOrder && !document.getElementById('orderId').value) {
          if(confirm(`‚ö†Ô∏è Order No "${orderNo}" already exists for customer "${existingOrder.cust}".\n\nDo you want to ADD these new items to their account? (Yes = Merge, No = Cancel)`)) {
              isDuplicateMerge = true;
          } else {
              return; 
          }
      }

      const boxGroups = [];
      document.querySelectorAll('.box-group-container').forEach(group => {
          const items = [];
          group.querySelectorAll('.item-row').forEach(row => {
              items.push({
                  name: row.querySelector('.item-name').value,
                  qty: row.querySelector('.item-qty').value,
                  rate: row.querySelector('.item-rate').value,
                  remark: row.querySelector('.item-remark').value
              });
          });
          boxGroups.push({
              groupName: group.querySelector('.group-name').value || 'Un-named Box',
              groupQty: group.querySelector('.group-qty').value,
              items: items
          });
      });

      if(boxGroups.length === 0) return alert("Add at least one box.");

      let id = isDuplicateMerge ? existingOrder.id : (document.getElementById('orderId').value || genId());
      
      const currentItemsSubTotal = parseFloat(document.getElementById('subTotal').value) || 0;
      const currentDiscount = parseFloat(document.getElementById('discount').value) || 0;
      const currentNewTotal = parseFloat(document.getElementById('totalAmount').value) || 0;
      
      try {
          if (isDuplicateMerge) {
              const updatedBoxGroups = [...existingOrder.boxGroups, ...boxGroups];
              const oldTotal = parseFloat(existingOrder.total) || 0;
              const newGrandTotal = oldTotal + currentNewTotal;

              await updateDoc(doc(db, "orders", id), {
                  boxGroups: updatedBoxGroups,
                  total: newGrandTotal,
                  delDate: document.getElementById('deliveryDate').value
              });

              const additionalDebitId = genId();
              await setDoc(doc(db, "ledger", additionalDebitId), {
                  id: additionalDebitId,
                  type: 'DEBIT',
                  orderId: id,
                  cust: existingOrder.cust,
                  date: document.getElementById('orderDate').value,
                  amount: currentNewTotal,
                  desc: `Order #${orderNo} (Added Items)`
              });

              alert(`Added new items to existing Order #${orderNo}.\nAccount debited by ‚Çπ${currentNewTotal}.`);

          } else {
              const isEdit = document.getElementById('orderId').value !== "";
              
              const newOrder = {
                  id: id,
                  no: orderNo,
                  date: document.getElementById('orderDate').value,
                  delDate: document.getElementById('deliveryDate').value,
                  delTime: document.getElementById('deliveryTime').value,
                  cust: document.getElementById('customerName').value,
                  mobile: document.getElementById('mobile').value,
                  type: document.getElementById('orderType').value,
                  note: document.getElementById('orderRemark').value,
                  boxGroups: boxGroups,
                  subTotal: currentItemsSubTotal,
                  discount: currentDiscount,
                  total: currentNewTotal
              };
              
              await setDoc(doc(db, "orders", id), newOrder);

              if(isEdit) {
                 const existingDebit = globalLedger.find(l => l.orderId === id && l.type === 'DEBIT');
                 if(existingDebit) {
                     await updateDoc(doc(db, "ledger", existingDebit.id), {
                         amount: currentNewTotal,
                         cust: newOrder.cust,
                         date: newOrder.date
                     });
                 }
              } else {
                  const debitEntryId = genId();
                  await setDoc(doc(db, "ledger", debitEntryId), {
                      id: debitEntryId, 
                      type:'DEBIT', 
                      orderId: id, 
                      cust: newOrder.cust, 
                      date: newOrder.date, 
                      amount: currentNewTotal, 
                      desc: 'Order #'+newOrder.no + (currentDiscount>0 ? ' (Disc: '+currentDiscount+')' : '')
                  });
              }
              alert('Order Saved to Cloud!');
          }

          const adv = parseFloat(document.getElementById('advancePaid').value);
          if(adv > 0) {
               const payDate = document.getElementById('advanceDate').value || today;
               const payId = genId();
               await setDoc(doc(db, "ledger", payId), {
                   id: payId, type:'CREDIT', orderId: id, cust: document.getElementById('customerName').value, date: payDate, amount: adv, mode: document.getElementById('paymentMode').value, desc: 'Advance/Payment'
               });
          }

          this.reset();
          document.getElementById('boxContainer').innerHTML = '';
          window.addBoxGroup();
          document.getElementById('orderId').value = '';
          document.getElementById('orderDate').value = today;
          document.getElementById('deliveryDate').value = today;

      } catch(err) {
          alert("Error saving: " + err.message);
      }
  });

  // --- RENDER FUNCTIONS ---
  window.renderProduction = () => {
      const date = document.getElementById('prodDateFilter').value;
      const search = document.getElementById('prodSearchFilter').value.toLowerCase();
      document.getElementById('printDateProd').textContent = "Production Date: " + window.formatDate(date);
      const orders = globalOrders.filter(o => o.delDate === date);
      const tbody = document.querySelector('#productionTable tbody');
      tbody.innerHTML = '';
      if(orders.length === 0) { tbody.innerHTML='<tr><td colspan="3">No orders</td></tr>'; return; }

      const prodSummary = {}; 
      orders.forEach(o => {
          o.boxGroups.forEach(bg => {
              const boxCount = parseFloat(bg.groupQty) || 0;
              bg.items.forEach(i => {
                  const itemName = i.name.trim();
                  if(!itemName || (search && !itemName.toLowerCase().includes(search))) return;
                  const totalQty = boxCount * (parseFloat(i.qty) || 0);
                  if (!prodSummary[itemName]) prodSummary[itemName] = { qty: 0, remarks: new Set() };
                  prodSummary[itemName].qty += totalQty;
                  if (i.remark) prodSummary[itemName].remarks.add(i.remark);
              });
          });
      });

      for (const [name, data] of Object.entries(prodSummary)) {
          tbody.innerHTML += `<tr><td style="font-weight:bold;">${name}</td><td style="font-size:16px; color:#d35400; font-weight:bold;">${data.qty.toFixed(3)}</td><td>${Array.from(data.remarks).join(', ')}</td></tr>`;
      }
  }

  window.renderPacking = () => {
      const date = document.getElementById('packDateFilter').value;
      const search = document.getElementById('packSearchFilter').value.toLowerCase();
      document.getElementById('printDatePack').textContent = "Packing Date: " + window.formatDate(date);
      let orders = globalOrders.filter(o => o.delDate === date);
      orders.sort((a,b) => (a.delTime||'').localeCompare(b.delTime||''));
      const tbody = document.querySelector('#packingTable tbody');
      tbody.innerHTML = '';
      orders.forEach(o => {
          if(search && !o.cust.toLowerCase().includes(search)) return;
          let detailsHtml = '';
          o.boxGroups.forEach(bg => {
              let itemsList = bg.items.map(i => `${i.name} (${i.qty}) ${i.remark ? '<span style="color:red">['+i.remark+']</span>':''}`).join(', ');
              detailsHtml += `<div style="border-bottom:1px dashed #ccc; padding:3px 0;"><span style="font-weight:bold; color:#d35400;">${bg.groupQty} x ${bg.groupName}</span><br><span style="font-size:11px;">${itemsList}</span></div>`;
          });
          tbody.innerHTML += `<tr><td>${window.formatAMPM(o.delTime)}</td><td><b>${o.cust}</b><br>${o.mobile}</td><td>${detailsHtml}</td><td>${o.note || ''}</td></tr>`;
      });
  }

  window.renderSummary = () => {
      const date = document.getElementById('summaryDateFilter').value;
      document.getElementById('printDateSum').textContent = "Summary Date: " + window.formatDate(date);
      
      let totalInc = 0, totalExp = 0, modeCounts = {}; 

      globalLedger.forEach(l => {
          if(l.date === date) {
              const amt = parseFloat(l.amount) || 0;
              if(l.type === 'CREDIT' || l.type === 'EXTRA_INCOME') {
                  totalInc += amt;
                  const m = (l.mode || 'Unknown').trim();
                  modeCounts[m] = (modeCounts[m] || 0) + amt;
              } else if(l.type === 'EXPENSE') {
                  totalExp += amt;
              }
          }
      });

      // --- NEW: Calculate Total Credit (Udhaar) for Today's Orders ---
      let totalUdhaar = 0;
      const todaysOrders = globalOrders.filter(o => o.delDate === date);
      todaysOrders.forEach(o => {
          const paid = globalLedger.filter(l => (l.type === 'CREDIT' || l.type === 'DISCOUNT') && l.orderId === o.id)
                                   .reduce((sum, l) => sum + parseFloat(l.amount||0), 0);
          const due = o.total - paid;
          if(due > 0) totalUdhaar += due;
      });
      // ----------------------------------------------------------------

      const dash = document.getElementById('summaryDashboard');
      let boxesHtml = `
          <div class="summary-card" style="border-left-color: #4caf50; background-color: #e8f5e9;"><h4>Total Collection</h4><div class="value">${window.formatMoney(totalInc)}</div></div>
          <div class="summary-card" style="border-left-color: #f44336; background-color: #ffebee;"><h4>Less: Expenses</h4><div class="value" style="color:#c62828;">- ${window.formatMoney(totalExp)}</div></div>
          <div class="summary-card" style="border-left-color: #2196f3; background-color: #e3f2fd;"><h4>CASH IN HAND</h4><div class="value" style="color:#1565c0; border:2px solid #2196f3; padding:5px;">${window.formatMoney(totalInc - totalExp)}</div></div>
      `;
      
      // Payment Breakdown Cards
      for (const [mode, val] of Object.entries(modeCounts)) {
          if(val > 0) {
              let displayVal = val;
              let label = mode + " Total";
              if(mode.toUpperCase().includes('CASH')) { displayVal = val - totalExp; label = mode + " (Net)"; }
              boxesHtml += `<div class="summary-card" style="${window.getCardStyle(mode)}"><h4>${label}</h4><div class="value">${window.formatMoney(displayVal)}</div></div>`;
          }
      }

      // --- ADD: Credit Total Card (Purple) ---
      if(totalUdhaar > 0) {
           boxesHtml += `<div class="summary-card" style="border-left-color: #9c27b0; background-color: #f3e5f5; color: #7b1fa2;"><h4>Credits Total (Udhaar)</h4><div class="value">${window.formatMoney(totalUdhaar)}</div></div>`;
      }
      // ----------------------------------------

      dash.innerHTML = boxesHtml;

      const tbody = document.querySelector('#summaryTable tbody');
      tbody.innerHTML = '';
      const uniqueOrds = [...new Set(globalLedger.filter(l => l.date === date && l.orderId).map(t=>t.orderId))];
      
      // FIX: Add orders delivered TODAY that have NO ledger entries yet (Full Credit / Udhaar cases like Nitin Kumar)
      todaysOrders.forEach(o => {
         if(!uniqueOrds.includes(o.id)) uniqueOrds.push(o.id);
      });

      uniqueOrds.forEach(oid => {
          const ord = globalOrders.find(o=>o.id===oid);
          if(ord) {
              const allTxns = globalLedger.filter(l => (l.type === 'CREDIT' || l.type === 'DISCOUNT') && l.orderId === oid);
              allTxns.sort((a,b) => new Date(b.date) - new Date(a.date));

              let historyHtml = '';
              let paidTotalEver = 0;

              allTxns.forEach(t => {
                  paidTotalEver += parseFloat(t.amount);
                  const isCurrentDate = t.date === date;
                  
                  if(isCurrentDate) {
                      historyHtml += `
                      <div class="mode-badge" style="${window.getModeBadgeStyle(t.mode)}">
                          <div style="display:flex; justify-content:space-between; align-items:center;">
                              <span><b>${window.formatMoney(t.amount)}</b> <span style="font-size:11px">(${t.mode})</span></span>
                              <div class="badge-actions">
                                  <button class="btn-icon icon-edit" onclick="window.openEditPayment('${t.id}')">‚úé</button>
                                  <button class="btn-icon icon-del" onclick="window.deleteTransaction('${t.id}')">‚úñ</button>
                              </div>
                          </div>
                      </div>`;
                  } else {
                      historyHtml += `
                      <div class="pay-history-item">
                          <span>${window.formatDate(t.date)}:</span>
                          <span><b>${window.formatMoney(t.amount)}</b> (${t.mode})</span>
                      </div>`;
                  }
              });

              // --- FIX: IF NO PAYMENT MADE, SHOW 'FULL CREDIT' BADGE ---
              // --- UPDATED: Button wrapped in badge-actions to hide on print ---
              if(paidTotalEver === 0 && ord.total > 0) {
                   historyHtml = `
                   <div class="mode-badge" style="background:#f3e5f5; color:#7b1fa2; border:1px solid #e1bee7; border-left-color:#7b1fa2;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span><b>Full Credit</b> <span style="font-size:10px">(Udhaar)</span></span>
                            <div class="badge-actions">
                                <button class="btn-icon icon-edit" onclick="window.openPay('${ord.id}')" title="Add Payment">‚ûï Pay</button>
                            </div>
                        </div>
                   </div>`;
              }
              // --------------------------------------------------------

              const due = ord.total - paidTotalEver;
              let boxDetailsStr = "";
              // --- UPDATED: Now shows detailed items and rates below box group ---
              if(ord.boxGroups){
                   boxDetailsStr = ord.boxGroups.map(bg => {
                       const itemDetails = bg.items.map(i => `${i.name} (${i.qty} x ${i.rate})`).join(', ');
                       return `<div style="margin-bottom:5px; border-bottom:1px dashed #eee;">
                                   <b>${bg.groupQty} x ${bg.groupName}</b><br>
                                   <span style="font-size:11px; color:#666;">${itemDetails}</span>
                               </div>`;
                   }).join('');
              }

              // Only show if delivered today OR has a payment entry today
              if(ord.delDate === date || historyHtml.includes('mode-badge')) {
                  tbody.innerHTML += `<tr><td>${ord.no}</td><td>${window.formatDate(ord.delDate)}</td><td>${ord.cust}</td><td>${boxDetailsStr}</td><td>${window.formatMoney(ord.total)}</td><td>${historyHtml}</td><td style="color:${due>0?'red':'green'}">${window.formatMoney(due)}</td></tr>`;
              }
          }
      });

      const expTbody = document.querySelector('#summaryExpenseTable tbody');
      expTbody.innerHTML = '';
      globalLedger.filter(l => l.type === 'EXPENSE' && l.date === date).forEach(ex => {
           expTbody.innerHTML += `<tr><td>${ex.desc}</td><td>${ex.mode}</td><td style="font-weight:bold; color:#c0392b;">${window.formatMoney(ex.amount)}</td></tr>`;
      });
      expTbody.innerHTML += `<tr style="background:#ffebee; font-weight:bold;"><td colspan="2" style="text-align:right;">Total:</td><td style="color:#c0392b;">${window.formatMoney(totalExp)}</td></tr>`;
  }

  // --- NEW: MONTHLY REPORTS (UPDATED TO INCLUDE EXTRA INCOME SEPARATELY) ---
  window.renderMonthReports = () => {
      const monthInput = document.getElementById('monthInput').value; // Format: YYYY-MM
      if(!monthInput) return;
      document.getElementById('printDateMonth').innerText = "Monthly Report: " + monthInput;

      const daysInMonth = new Date(monthInput.split('-')[0], monthInput.split('-')[1], 0).getDate();
      const dailyData = {};

      for(let i=1; i<=daysInMonth; i++) {
          const d = i < 10 ? '0'+i : i;
          const fullDate = `${monthInput}-${d}`;
          // Initialize data structure with all fields
          dailyData[fullDate] = { 
              orders: 0, 
              sales: 0, 
              sweets: 0, // Sweets Collection
              restCash: 0, // New
              restOnline: 0, // New
              showCash: 0, // New
              showOnline: 0, // New
              expense: 0 
          };
      }

      globalOrders.forEach(o => {
          if(o.date.startsWith(monthInput)) {
              if(dailyData[o.date]) {
                  dailyData[o.date].orders += 1;
                  dailyData[o.date].sales += parseFloat(o.total || 0);
              }
          }
      });

      globalLedger.forEach(l => {
          if(l.date.startsWith(monthInput) && dailyData[l.date]) {
              const amt = parseFloat(l.amount || 0);
              const isCash = l.mode && (l.mode.toLowerCase().includes('cash') || l.mode.toLowerCase().includes('counter'));

              if(l.type === 'CREDIT') {
                  // Sweets Collection
                  dailyData[l.date].sweets += amt;
              }
              else if(l.type === 'EXTRA_INCOME') {
                  // Separate based on source AND mode
                  if(l.source === 'Restaurant') {
                      if(isCash) dailyData[l.date].restCash += amt;
                      else dailyData[l.date].restOnline += amt;
                  } else if(l.source === 'Showroom') {
                      if(isCash) dailyData[l.date].showCash += amt;
                      else dailyData[l.date].showOnline += amt;
                  }
              }
              else if(l.type === 'EXPENSE') {
                  dailyData[l.date].expense += amt;
              }
          }
      });

      // Calculate Grand Totals
      let grand = { orders:0, sales:0, sweets:0, restCash:0, restOnline:0, showCash:0, showOnline:0, totalColl:0, expense:0, net:0 };

      // Update Table Headers
      const thead = document.querySelector('#monthTable thead');
      thead.innerHTML = `
        <tr>
            <th style="width:10%">Date</th>
            <th style="width:5%">Ord</th>
            <th style="width:10%; text-align:right;">Sweets</th>
            <th style="width:10%; text-align:right; color:#d35400;">Rest. Cash</th>
            <th style="width:10%; text-align:right; color:#e67e22;">Rest. UPI</th>
            <th style="width:10%; text-align:right; color:#8e44ad;">Show. Cash</th>
            <th style="width:10%; text-align:right; color:#9b59b6;">Show. UPI</th>
            <th style="width:10%; text-align:right; color:#27ae60; font-weight:bold;">Total Inc.</th>
            <th style="width:10%; text-align:right; color:#c0392b;">Exp</th>
            <th style="width:10%; text-align:right;">Net Profit</th>
        </tr>
      `;

      const tbody = document.getElementById('monthTableBody');
      tbody.innerHTML = '';
      
      Object.keys(dailyData).sort().forEach(date => {
          const d = dailyData[date];
          if(d.orders === 0 && d.sales === 0 && d.sweets === 0 && d.restCash === 0 && d.restOnline === 0 && d.showCash === 0 && d.showOnline === 0 && d.expense === 0) return;
          
          const totalDailyIncome = d.sweets + d.restCash + d.restOnline + d.showCash + d.showOnline;
          const net = totalDailyIncome - d.expense;
          
          // Accumulate Grand Totals
          grand.orders += d.orders;
          grand.sales += d.sales;
          grand.sweets += d.sweets;
          grand.restCash += d.restCash;
          grand.restOnline += d.restOnline;
          grand.showCash += d.showCash;
          grand.showOnline += d.showOnline;
          grand.totalColl += totalDailyIncome;
          grand.expense += d.expense;
          grand.net += net;

          tbody.innerHTML += `
            <tr>
                <td>${window.formatDate(date)}</td>
                <td>${d.orders}</td>
                <td style="text-align:right; color:#2980b9;">${window.formatMoney(d.sweets)}</td>
                
                <td style="text-align:right; color:#d35400;">${window.formatMoney(d.restCash)}</td>
                <td style="text-align:right; color:#e67e22;">${window.formatMoney(d.restOnline)}</td>
                
                <td style="text-align:right; color:#8e44ad;">${window.formatMoney(d.showCash)}</td>
                <td style="text-align:right; color:#9b59b6;">${window.formatMoney(d.showOnline)}</td>
                
                <td style="text-align:right; font-weight:bold; color:#27ae60;">${window.formatMoney(totalDailyIncome)}</td>
                <td style="text-align:right; font-weight:bold; color:#c0392b;">${window.formatMoney(d.expense)}</td>
                <td style="text-align:right; font-weight:bold;">${window.formatMoney(net)}</td>
            </tr>
          `;
      });

      // Add Footer Row (NICHE TOTAL)
      tbody.innerHTML += `
        <tr style="background:#f0f0f0; font-weight:bold; border-top:2px solid #333;">
            <td>TOTAL</td>
            <td>${grand.orders}</td>
            <td style="text-align:right; color:#2980b9;">${window.formatMoney(grand.sweets)}</td>
            
            <td style="text-align:right; color:#d35400;">${window.formatMoney(grand.restCash)}</td>
            <td style="text-align:right; color:#e67e22;">${window.formatMoney(grand.restOnline)}</td>
            
            <td style="text-align:right; color:#8e44ad;">${window.formatMoney(grand.showCash)}</td>
            <td style="text-align:right; color:#9b59b6;">${window.formatMoney(grand.showOnline)}</td>
            
            <td style="text-align:right; color:#27ae60;">${window.formatMoney(grand.totalColl)}</td>
            <td style="text-align:right; color:#c0392b;">${window.formatMoney(grand.expense)}</td>
            <td style="text-align:right;">${window.formatMoney(grand.net)}</td>
        </tr>
      `;
      
      // Update Dashboard Cards with granular data (Can be simplified or detailed)
      const dash = document.getElementById('monthDashboard');
      dash.innerHTML = `
        <div class="summary-card" style="border-left-color: #2980b9; background-color: #e1f5fe;"><h4>Sweets</h4><div class="value">${window.formatMoney(grand.sweets)}</div></div>
        <div class="summary-card" style="border-left-color: #d35400; background-color: #fff3e0;"><h4>Restaurant</h4><div class="value">${window.formatMoney(grand.restCash + grand.restOnline)}</div></div>
        <div class="summary-card" style="border-left-color: #8e44ad; background-color: #f3e5f5;"><h4>Showroom</h4><div class="value">${window.formatMoney(grand.showCash + grand.showOnline)}</div></div>
        <div class="summary-card" style="border-left-color: #27ae60; background-color: #e8f5e9;"><h4>Total Income</h4><div class="value">${window.formatMoney(grand.totalColl)}</div></div>
        <div class="summary-card" style="border-left-color: #2c3e50; background-color: #eceff1;"><h4>NET PROFIT</h4><div class="value" style="color:#2c3e50;">${window.formatMoney(grand.net)}</div></div>
      `;

      // --- RENDER EXTRA INCOME TABLE ---
      const extraTbody = document.querySelector('#otherIncomeTable tbody');
      extraTbody.innerHTML = '';
      const extraIncomes = globalLedger.filter(l => l.type === 'EXTRA_INCOME' && l.date.startsWith(monthInput)).sort((a,b) => new Date(b.date) - new Date(a.date));
      
      extraIncomes.forEach(inc => {
          extraTbody.innerHTML += `
            <tr>
                <td>${window.formatDate(inc.date)}</td>
                <td>${inc.source}</td>
                <td style="font-weight:bold; color:green;">${window.formatMoney(inc.amount)}</td>
                <td>${inc.mode}</td>
                <td class="filter-controls-screen">
                    <button class="btn-icon icon-edit" onclick="window.editIncome('${inc.id}')">‚úé</button>
                    <button class="btn-icon icon-del" onclick="window.deleteTransaction('${inc.id}')">‚úñ</button>
                </td>
            </tr>`;
      });
  }

  // --- NEW FUNCTIONS: OPEN, EDIT, SAVE OTHER INCOME ---
  
  window.openIncomeModal = () => {
      document.getElementById('incId').value = '';
      document.getElementById('incDate').value = today;
      document.getElementById('incSource').value = 'Restaurant';
      document.getElementById('incAmt').value = '';
      document.getElementById('incMode').value = 'Cash'; // Default
      document.getElementById('incModalTitle').innerText = "Add Other Daily Income";
      document.getElementById('incSaveBtn').innerText = "Save Income";
      document.getElementById('incomeModal').style.display='block';
  }

  window.editIncome = (id) => {
      const inc = globalLedger.find(l => l.id === id);
      if(!inc) return;
      document.getElementById('incId').value = inc.id;
      document.getElementById('incDate').value = inc.date;
      document.getElementById('incSource').value = inc.source;
      document.getElementById('incAmt').value = inc.amount;
      document.getElementById('incMode').value = inc.mode;
      
      document.getElementById('incModalTitle').innerText = "Edit Income Entry";
      document.getElementById('incSaveBtn').innerText = "Update Entry";
      document.getElementById('incomeModal').style.display='block';
  }

  window.saveOtherIncome = async () => {
      const id = document.getElementById('incId').value || genId();
      const date = document.getElementById('incDate').value;
      const source = document.getElementById('incSource').value;
      const amount = parseFloat(document.getElementById('incAmt').value);
      const mode = document.getElementById('incMode').value;

      if(!date || !amount) return alert("Please fill Date and Amount");

      const isEdit = document.getElementById('incId').value !== "";
      
      const data = {
          id: id,
          type: 'EXTRA_INCOME',
          date: date,
          amount: amount,
          source: source,
          mode: mode,
          desc: `${source} Sales`
      };

      if(isEdit) {
          await updateDoc(doc(db, "ledger", id), data);
      } else {
          await setDoc(doc(db, "ledger", id), data);
      }

      document.getElementById('incomeModal').style.display = 'none';
      alert(isEdit ? "Income Updated!" : "Income Added!");
  }

  // --- ACTIONS (DELETE/EDIT) ---
  window.deleteTransaction = async (id) => {
      if(!confirm("Delete this entry? Cloud will update immediately.")) return;
      await deleteDoc(doc(db, "ledger", id));
  }

  window.deleteOrder = async (id) => {
      if(confirm("DELETE ORDER? This removes the order and ALL its ledger entries from Cloud.")) {
          await deleteDoc(doc(db, "orders", id));
          const relatedLedger = globalLedger.filter(l => l.orderId === id);
          relatedLedger.forEach(async (l) => {
              await deleteDoc(doc(db, "ledger", l.id));
          });
          alert("Deleted from Cloud.");
      }
  }

  // --- DUE PAYMENTS ---
  window.renderDuePayments = () => {
      const q = document.getElementById('dueSearchInput').value.toLowerCase();
      const filterDate = document.getElementById('dueDetailDate').value;
      const tbody = document.querySelector('#dueTable tbody');
      tbody.innerHTML = '';
      let totalDue = 0;

      globalOrders.forEach(o => {
          if(filterDate && o.date !== filterDate) return;
          const paid = globalLedger.filter(l=>(l.type==='CREDIT' || l.type==='DISCOUNT') && l.orderId===o.id).reduce((s,l)=>s+parseFloat(l.amount),0);
          const due = o.total - paid;
          if(due > 1) {
              if(q && !o.cust.toLowerCase().includes(q) && !o.no.toLowerCase().includes(q)) return;
              totalDue += due;
              tbody.innerHTML += `<tr><td>${window.formatDate(o.date)}</td><td>${o.no}</td><td>${o.cust}<br><small>${o.mobile}</small></td><td>${window.formatMoney(o.total)}</td><td>${window.formatMoney(paid)}</td><td style="color:red;font-weight:bold">${window.formatMoney(due)}</td><td class="filter-controls-screen"><button class="btn btn-sm btn-success" onclick="window.openPay('${o.id}')">Pay</button></td></tr>`;
          }
      });
      if(totalDue > 0) tbody.innerHTML += `<tr style="background:#fff3e0; font-weight:bold;"><td colspan="5" style="text-align:right">Total Pending:</td><td style="color:red;">${window.formatMoney(totalDue)}</td><td></td></tr>`;
  }

  // --- ALL ORDERS ---
  window.renderAllOrders = () => {
      const q = document.getElementById('searchOrder').value.toLowerCase();
      const fromDate = document.getElementById('searchFromDate').value;
      const toDate = document.getElementById('searchToDate').value;
      const tbody = document.querySelector('#allOrdersTable tbody');
      tbody.innerHTML = '';
      
      const sorted = [...globalOrders].sort((a,b) => new Date(b.date) - new Date(a.date));

      sorted.forEach(o => {
          if (fromDate && o.date < fromDate) return;
          if (toDate && o.date > toDate) return;
          if(o.no.toLowerCase().includes(q) || o.cust.toLowerCase().includes(q)) {
              let boxSum = o.boxGroups.map(bg => `${bg.groupQty}x ${bg.groupName}`).join(', ');
              tbody.innerHTML += `<tr><td>${window.formatDate(o.date)}</td><td>${o.no}</td><td>${o.cust}</td><td><small>${boxSum}</small></td><td>${window.formatMoney(o.total)}</td><td class="filter-controls-screen"><button class="btn btn-sm btn-primary" onclick="window.editOrder('${o.id}')">Edit</button> <button class="btn btn-sm btn-danger" onclick="window.deleteOrder('${o.id}')">Del</button></td></tr>`;
          }
      });
  }

  // --- LEDGER (FIXED: Improved populating logic) ---
  window.populateLedgerSelect = () => {
      const sel = document.getElementById('ledgerCustomerSelect');
      const currentVal = sel.value; // Store current selection to prevent reset

      // Get unique customers from BOTH Orders AND Ledger
      const orderCusts = globalOrders.map(o => o.cust);
      const ledgerCusts = globalLedger.map(l => l.cust);
      
      const allCusts = [...new Set([...orderCusts, ...ledgerCusts])];
      const sortedCusts = allCusts.filter(c => c && c.trim() !== "").sort();

      sel.innerHTML = '<option value="">-- Select Customer --</option>';
      sortedCusts.forEach(c => {
          const isSelected = c === currentVal ? 'selected' : '';
          sel.innerHTML += `<option value="${c}" ${isSelected}>${c}</option>`;
      });
  }

  window.renderLedger = () => {
      const cust = document.getElementById('ledgerCustomerSelect').value;
      if (!cust) {
          // Hide ledger if no customer selected
          document.getElementById('ledgerContent').style.display = 'none';
          return;
      }
      
      const ledger = globalLedger.filter(l => l.cust === cust).sort((a,b) => new Date(a.date) - new Date(b.date));
      const linkedOrder = globalOrders.find(o => o.cust === cust);
      
      document.getElementById('printLedgerCustName').innerText = cust;
      document.getElementById('printLedgerMobile').innerText = linkedOrder ? "Mobile: " + linkedOrder.mobile : "";
      document.getElementById('printLedgerDate').innerText = window.formatDate(today);
      document.getElementById('ledgerContent').style.display = 'block';
      
      const tbody = document.querySelector('#ledgerTable tbody');
      tbody.innerHTML = '';
      let runningBalance = 0, totalDebit = 0, totalCredit = 0;

      ledger.forEach(l => {
          const amount = parseFloat(l.amount);
          if (l.type === 'DEBIT') { runningBalance += amount; totalDebit += amount; }
          if (l.type === 'CREDIT' || l.type === 'DISCOUNT') { runningBalance -= amount; totalCredit += amount; }
          
          const debit = l.type === 'DEBIT' ? window.formatMoney(amount) : '';
          const credit = (l.type === 'CREDIT' || l.type === 'DISCOUNT') ? window.formatMoney(amount) : '';
          const desc = l.type === 'DISCOUNT' ? `<b>Discount</b>` : (l.desc || 'Order');
          
          const action = (l.type === 'CREDIT' || l.type === 'DISCOUNT') ? `<button class="btn btn-sm btn-warning" onclick="window.openEditPayment('${l.id}')">Edit</button> <button class="btn btn-sm btn-danger" onclick="window.deleteTransaction('${l.id}')">Del</button>` : '';

          tbody.innerHTML += `<tr><td>${window.formatDate(l.date)}</td><td>${desc} <small>(${l.mode || 'Bill'})</small></td><td style="text-align:right;">${debit}</td><td style="text-align:right;">${credit}</td><td style="text-align:right; font-weight:bold;">${window.formatMoney(runningBalance)}</td><td class="filter-controls-screen">${action}</td></tr>`;
      });
      
      document.getElementById('ledgerTotalDebit').innerText = window.formatMoney(totalDebit);
      document.getElementById('ledgerTotalCredit').innerText = window.formatMoney(totalCredit);
      document.getElementById('ledgerBalance').innerText = window.formatMoney(runningBalance);
  }

  // --- EDIT/PAYMENT UTILS ---
  window.editOrder = (id) => {
      const o = globalOrders.find(x => x.id === id);
      if(!o) return;
      document.getElementById('orderId').value = o.id;
      document.getElementById('orderNo').value = o.no;
      document.getElementById('orderDate').value = o.date;
      document.getElementById('deliveryDate').value = o.delDate;
      document.getElementById('deliveryTime').value = o.delTime;
      document.getElementById('customerName').value = o.cust;
      document.getElementById('mobile').value = o.mobile;
      document.getElementById('orderType').value = o.type;
      document.getElementById('orderRemark').value = o.note;
      document.getElementById('boxContainer').innerHTML = '';
      if(o.boxGroups) o.boxGroups.forEach(bg => window.addBoxGroup(bg));
      document.getElementById('discount').value = o.discount || 0;
      window.calculateGrandTotal();
      window.openTab('addOrder', document.querySelector('.tab-menu button:first-child'));
  }

  window.openPay = (id) => {
      document.getElementById('modalOrderId').value = id;
      document.getElementById('modalPayDate').value = today;
      document.getElementById('modalPayAmt').value = '';
      document.getElementById('modalDiscount').value = '';
      document.getElementById('payModal').style.display = 'block';
  }

  window.savePayment = async () => {
      const id = document.getElementById('modalOrderId').value;
      const amt = parseFloat(document.getElementById('modalPayAmt').value) || 0;
      const disc = parseFloat(document.getElementById('modalDiscount').value) || 0;
      const mode = document.getElementById('modalPayMode').value;
      const date = document.getElementById('modalPayDate').value; 
      const o = globalOrders.find(x => x.id === id);
      
      if(amt > 0) {
          const pid = genId();
          await setDoc(doc(db, "ledger", pid), {id: pid, type:'CREDIT', orderId:id, cust:o.cust, date:date, amount:amt, mode:mode, desc:'Payment Received'});
      }
      if(disc > 0) {
          const did = genId();
          await setDoc(doc(db, "ledger", did), {id: did, type:'DISCOUNT', orderId:id, cust:o.cust, date:date, amount:disc, mode:'Discount', desc:'Discount Given'});
      }
      document.getElementById('payModal').style.display = 'none';
      alert("Payment Saved to Cloud");
  }

  window.openEditPayment = (id) => {
      const entry = globalLedger.find(l => l.id === id);
      if(!entry) return;
      document.getElementById('editPayId').value = id;
      document.getElementById('editPayDate').value = entry.date;
      document.getElementById('editPayAmt').value = entry.amount;
      document.getElementById('editPayMode').value = entry.mode;
      document.getElementById('editPayModal').style.display = 'block';
  }

  window.saveEditedPayment = async () => {
      const id = document.getElementById('editPayId').value;
      const date = document.getElementById('editPayDate').value;
      const amt = parseFloat(document.getElementById('editPayAmt').value);
      const mode = document.getElementById('editPayMode').value;
      
      await updateDoc(doc(db, "ledger", id), { date: date, amount: amt, mode: mode });
      document.getElementById('editPayModal').style.display = 'none';
      alert("Payment Updated in Cloud");
  }

  // --- EXPENSES ---
  window.renderExpenses = () => {
      document.getElementById('expDate').value = today;
      const ledger = globalLedger.filter(l => l.type === 'EXPENSE');
      const tbody = document.querySelector('#expenseTable tbody');
      tbody.innerHTML = '';
      ledger.reverse().forEach(l => {
          tbody.innerHTML += `<tr><td>${window.formatDate(l.date)}</td><td>${l.desc}</td><td style="color:red; font-weight:bold">${l.amount}</td><td>${l.mode}</td><td class="filter-controls-screen"><button class="btn btn-sm btn-danger" onclick="window.deleteTransaction('${l.id}')">X</button></td></tr>`;
      });
  }

  window.addExpense = async () => {
      const date = document.getElementById('expDate').value;
      const amt = document.getElementById('expAmt').value;
      const desc = document.getElementById('expDetail').value;
      const mode = document.getElementById('expMode').value;
      if(!amt || !desc) return alert("Fill all fields");
      const id = genId();
      await setDoc(doc(db, "ledger", id), { id: id, type: 'EXPENSE', date: date, amount: amt, desc: desc, mode: mode });
      document.getElementById('expAmt').value = '';
      alert("Expense Added");
  }

  // --- IMPORT/EXPORT (SYSTEM ADMIN) - PASSWORD PROTECTED ---
  
  // UPDATED: Now prompts for password before export
  window.exportData = () => {
      const p = prompt("Enter Admin Password to Download Backup:");
      if (p !== "1234") {
          return alert("‚ùå Access Denied: Incorrect Password");
      }
      
      const data = {orders: globalOrders, ledger: globalLedger};
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([JSON.stringify(data)], {type:'application/json'}));
      a.download = 'RamKishanSweets_Backup.json';
      a.click();
  }
   
  // NEW: Checks password before triggering the file input
  window.checkPassAndImport = () => {
      const p = prompt("Enter Admin Password to Restore/Overwrite Data:");
      if (p !== "1234") {
          return alert("‚ùå Access Denied: Incorrect Password");
      }
      // If password correct, click the hidden file input
      document.getElementById('importFile').click();
  }

  // Calls this when file is selected
  window.importData = (input) => {
      const file = input.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async function(e) {
          try {
              if(!confirm("‚ö†Ô∏è WARNING: This will overwrite/merge cloud data. Continue?")) return;
              const data = JSON.parse(e.target.result);
              
              const batch = writeBatch(db);
              let count = 0;
              
              if (data.orders) {
                  data.orders.forEach(o => {
                      const ref = doc(db, "orders", o.id);
                      batch.set(ref, o);
                      count++;
                  });
              }
              if (data.ledger) {
                  data.ledger.forEach(l => {
                      const ref = doc(db, "ledger", l.id);
                      batch.set(ref, l);
                      count++;
                  });
              }
              await batch.commit();
              alert(`Successfully Restored ${count} records to Cloud!`);
          } catch (err) {
              alert('Error importing: ' + err.message);
          }
      };
      reader.readAsText(file);
      // Reset input so same file can be selected again if needed
      input.value = '';
  }
</script>
</body>
</html>
