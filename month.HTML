<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monthly Summary Tracker - 7 Column Merged (With Filters)</title> 
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* ====================================
           1. CSS (Styling and Responsiveness)
           ==================================== */
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f7f6;
            color: #333;
            font-size: 16px; 
        }
        .container {
            max-width: 1400px; 
            margin: 20px auto; 
            padding: 20px; 
            background: #ffffff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 25px;
        }
        h2, h3 {
            color: #34495e;
            font-size: 1.3em;
        }

        /* **Total Box Style - Screen View** */
        .totals-section {
            display: block; /* Changed from flex to block to stack the rows */
            margin-bottom: 20px; 
        }

        /* NEW: Style for the rows to contain exactly 4 items */
        .total-row {
            display: flex;
            flex-wrap: wrap; 
            gap: 8px; 
            justify-content: center; 
            margin-bottom: 8px; /* Space between the two 4-box rows */
        }
        
        /* Removed .total-group and .group-title styles */
        
        .total-box {
            background-color: #ecf0f1;
            padding: 8px 10px; 
            border-radius: 6px; 
            text-align: center;
            /* Adjusted flex to ensure 4 fit neatly in a row, while allowing wrap */
            flex: 1 1 calc(25% - 6px); 
            min-width: 100px; 
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            line-height: 1.2;
        }
        .total-box p {
            margin: 0 0 2px 0; 
            font-size: 0.7em; 
            color: #7f8c8d;
            font-weight: 700;
            text-transform: uppercase;
        }
        
        /* Font size for totals (Screen View) */
        #grand-total {
            color: #27ae60; 
            font-size: 1.5em; 
            margin: 0;
            white-space: nowrap; 
        }
        .total-box h3 {
            font-size: 1.1em; 
            margin: 0;
            line-height: 1.2;
            white-space: nowrap; 
        }
        
        /* Specific Colors for Totals (ORDER) */
        .total-order-cash { background-color: #e8f5e9; } 
        .total-order-upi { background-color: #e3f2fd; }  
        .total-sweets-cash { background-color: #bbdefb; border: 1px solid #2196f3; } /* Sweets Cash */
        .total-sweets-upi { background-color: #fce4ec; border: 1px solid #e74c3c; } /* Sweets UPI */
        .total-rest-cash { background-color: #fff9c4; border: 1px solid #fbc02d; } 
        .total-rest-upi { background-color: #c8e6c9; border: 1px solid #4caf50; }  
        .total-expenses { 
            border: 2px solid #e74c3c; 
            background-color: #ffebee;
        } 
        
        /* ====================================
           Entry Form & Filter Controls
           ==================================== */
        #payment-form, .filter-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px; 
            padding: 15px; 
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 20px;
            align-items: flex-end;
        }
        .filter-controls {
            border: 1px solid #2c3e50;
            background-color: #ecf0f1;
            align-items: center;
        }
        .filter-controls h3 {
            flex: 1 1 100%;
            margin-top: 0;
            margin-bottom: 5px;
        }
        .filter-controls .form-group {
            flex: 0 0 auto; 
            min-width: 150px;
        }
        
        .form-group {
            flex: 1 1 150px; 
            display: flex;
            flex-direction: column;
        }
        label {
            margin-bottom: 4px;
            font-weight: bold;
            color: #555;
            font-size: 0.9em; 
        }
        label.mandatory:after {
            content: " *";
            color: #e74c3c;
        }

        input[type="date"], input[type="number"], input[type="text"], select {
            padding: 8px; 
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
            font-size: 1.0em; 
        }
        .add-button {
            padding: 10px 20px; 
            font-size: 1.0em; 
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }


        /* ====================================
           Report Table (Screen View)
           ==================================== */
        .report-section {
            overflow-x: auto; 
        }
        #summary-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px; 
            min-width: 900px; /* 7 columns */
        }
        #summary-table th, #summary-table td {
            border: 1px solid #dfe6e9;
            padding: 8px 6px; 
            text-align: right; 
            font-size: 1.0em; 
        }
        #summary-table th {
            background-color: #2c3e50;
            color: white;
            text-transform: uppercase;
            font-size: 1.0em; 
            text-align: center; 
        }
        #summary-table td:first-child {
            text-align: left; 
            font-weight: bold;
            background-color: #f0f4f7;
            min-width: 110px;
        }
        
        /* Styling for amount columns (Screen View) */
        #summary-table td:not(:first-child):not(:last-child) {
            white-space: nowrap; 
            font-size: 1.0em; 
            min-width: 100px; 
        }

        /* Specific Cell Styles */
        .sweets-cash-cell { background-color: #e0f7fa; } /* Sweets Cash */
        .sweets-upi-cell { background-color: #ffebee; }  /* Sweets UPI */
        .rest-cash-cell { background-color: #fffde7; }
        .rest-upi-cell { background-color: #e8f5e9; }
        .order-cash-cell { background-color: #f1f8e9; }
        .order-upi-cell { background-color: #e9ebee; }

        #summary-table th:last-child {
            width: 150px; 
        }

        /* Action Buttons */
        .action-btns {
            display: flex;
            gap: 5px;
            justify-content: center;
        }
        .action-btns button {
            padding: 5px 8px; 
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9em; 
        }
        .delete-btn {
            background-color: #e74c3c;
            color: white;
        }
        .edit-btn {
            background-color: #f39c12;
            color: white;
        }
        
        /* Color Coding */
        .income-cell { color: #27ae60; font-weight: bold; } 
        .expense-cell { color: #e74c3c; font-weight: bold; } 
        .row-total { background-color: #e0f7fa; font-weight: bold; } 

        /* **Separator Line for different dates** */
        .date-separator {
            border-top: 2px solid #3498db; 
            height: 0;
            margin-top: 8px;
        }
        
        /* Modal and Import/Export Section */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none; 
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        .close-btn {
            float: right;
            font-size: 28px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
        }
        .report-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .import-export-btns button {
            padding: 8px 15px;
            margin-left: 10px;
            background-color: #1abc9c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .import-export-btns input[type="file"] {
            display: none;
        }

        /* ====================================
           6. PRINT MEDIA CSS (A4 Optimized)
           ==================================== */
        @media print {
            body { 
                font-size: 12px; 
            }
            .container {
                width: 100%;
                margin: 0;
                padding: 0;
                box-shadow: none;
            }
            
            /* Hide non-report elements */
            #payment-form, .print-button, hr, .report-controls, .modal, .import-export-btns,
            #summary-table th:last-child, #summary-table td:last-child, .filter-controls {
                display: none;
            }
            
            /* Totals Section Styling for Print */
            .totals-section { border-bottom: 1px solid #000; padding-bottom: 5px; margin-bottom: 10px; gap: 5px; }
            .total-row { display: flex; gap: 5px; justify-content: space-between; margin-bottom: 5px; }
            .total-box { padding: 3px; flex: 1 1 80px; border: 1px solid #000; } 
            .total-box p { font-size: 0.7em; margin: 0; }
            .total-box h3 { 
                font-size: 0.8em; 
                margin: 0; 
                white-space: nowrap; 
            }
            #grand-total { font-size: 1.0em; white-space: nowrap; } 
            
            /* Table Styling for Print */
            #summary-table { 
                border: 1px solid #000;
                width: 100%;
                min-width: auto;
            }
            #summary-table th, #summary-table td { 
                border: 1px solid #000; 
                padding: 4px; 
                font-size: 0.9em; 
            }
             #summary-table td:first-child {
                min-width: 70px; 
            }
            /* Adjusting width for the remaining columns */
            #summary-table td:not(:first-child) {
                min-width: 70px; 
            }
            
            * {
                -webkit-print-color-adjust: exact !important; 
                print-color-adjust: exact !important;         
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>üí∏ Monthly Summary Tracker</h1> 

        <div class="totals-section">
            <div class="total-row"> 
                <div class="total-box">
                    <p>Gross Income</p>
                    <h2 id="grand-total">‚Çπ 0.00</h2>
                </div>
                <div class="total-box total-order-cash">
                    <p>**ORDER CASH**</p>
                    <h3 id="total-order-cash">‚Çπ 0.00</h3>
                </div>
                <div class="total-box total-order-upi">
                    <p>**ORDER UPI**</p>
                    <h3 id="total-order-upi">‚Çπ 0.00</h3>
                </div>
                <div class="total-box total-sweets-cash">
                    <p>**SWEETS CASH**</p>
                    <h3 id="total-sweets-cash">‚Çπ 0.00</h3>
                </div>
            </div>

            <div class="total-row"> 
                <div class="total-box total-sweets-upi">
                    <p>**SWEETS UPI**</p>
                    <h3 id="total-sweets-upi">‚Çπ 0.00</h3>
                </div>
                <div class="total-box total-rest-cash">
                    <p>**REST CASH**</p>
                    <h3 id="total-rest-cash">‚Çπ 0.00</h3>
                </div>
                <div class="total-box total-rest-upi">
                    <p>**REST UPI**</p>
                    <h3 id="total-rest-upi">‚Çπ 0.00</h3>
                </div>
                
                <div class="total-box total-expenses"> 
                    <p>TOTAL EXPENSES</p>
                    <h3 id="total-combined-expenses">‚Çπ 0.00</h3>
                </div>
            </div>
        </div>

        <hr>

        <form id="payment-form">
            <h2>Add New Entry</h2>
            <div class="form-group">
                <label for="date" class="mandatory">Date:</label>
                <input type="date" id="date" required>
            </div>
            <div class="form-group">
                <label for="type">Transaction Type:</label>
                <select id="type"> 
                    <option value="OrderCash">ORDER CASH</option>
                    <option value="OrderUPI">ORDER UPI</option>
                    
                    <optgroup label="SWEETS INCOME">
                        <option value="LokendraCash">LOKENDRA CASH</option>
                        <option value="LokendraUPI">LOKENDRA UPI</option>
                        <option value="VikashCash">VIKASH CASH</option>
                        <option value="VikashUPI">VIKASH UPI</option>
                        <option value="SweetsCash">OTHER SWEETS CASH</option> 
                        <option value="SweetsUPI">OTHER SWEETS UPI</option>
                    </optgroup>
                    
                    <optgroup label="RESTAURANT INCOME">
                        <option value="DubeyCash">DUBEY CASH</option>
                        <option value="DubeyUPI">DUBEY UPI</option>
                        <option value="NipulCash">NIPUL CASH</option>
                        <option value="NipulUPI">NIPUL UPI</option>
                        <option value="RestCash">OTHER REST CASH</option> 
                        <option value="RestUPI">OTHER REST UPI</option>
                    </optgroup>

                    <option value="GeneralExpense">GENERAL EXPENSE</option>
                    <option value="LokendraExpense">LOKENDRA EXPENSE</option>
                    <option value="VikashExpense">VIKASH EXPENSE</option>
                </select>
            </div>
            <div class="form-group">
                <label for="amount">Amount (‚Çπ):</label>
                <input type="number" id="amount" step="0.01"> 
            </div>
            <div class="form-group">
                <label for="details">Details (Optional):</label>
                <input type="text" id="details">
            </div>
            <button type="submit" class="add-button">Add Entry</button>
        </form>
        
        <hr>
        
        <div class="filter-controls">
            <h3>Filter Report</h3>
            <div class="form-group">
                <label for="month-filter">Month:</label>
                <select id="month-filter"></select>
            </div>
            <div class="form-group">
                <label for="year-filter">Year:</label>
                <select id="year-filter"></select>
            </div>
            <button onclick="renderSummary()" class="add-button">Apply Filter</button>
        </div>
        
        <hr>

        <div class="report-section">
            <h2>üìä Monthly Summary Report</h2> 
            
            <div class="report-controls">
                <div class="import-export-btns">
                    <input type="file" id="importFile" accept=".csv" onchange="importData(event)">
                    <button onclick="document.getElementById('importFile').click()">Import Data üì•</button>
                    <button onclick="exportData()">Export Data üì§</button>
                </div>
                <button onclick="window.print()" class="print-button">Print Report üñ®Ô∏è</button>
            </div>
            
            <table id="summary-table">
                <thead>
                    <tr>
                        <th>DATE</th>
                        <th>ORDER CASH</th>
                        <th>ORDER UPI</th> 
                        <th>SWEETS CASH</th>
                        <th>SWEETS UPI</th>
                        <th>REST CASH</th> 
                        <th>REST UPI</th> 
                        <th>TOTAL EXPENSES</th> 
                        <th>ACTION</th> 
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
        
        <div id="editModal" class="modal">
            <div class="modal-content">
                <span class="close-btn" onclick="closeModal()">&times;</span>
                <h3>Edit Entries for: <span id="modal-date-title"></span></h3>
                <p>‡§Ø‡§π‡§æ‡§Ç ‡§Ü‡§™ ‡§á‡§∏ ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§ï‡•Ä ‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡§ø‡§ó‡§§ ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä‡•õ ‡§ï‡•ã ‡§è‡§°‡§ø‡§ü ‡§Ø‡§æ ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§</p>
                
                <table id="edit-list-table">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Amount (‚Çπ)</th>
                            <th>Details</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="edit-list-body">
                        </tbody>
                </table>
                <br>
                <button onclick="closeModal(); renderSummary();" class="add-button">Done Editing & Refresh Report</button>
            </div>
        </div>

    </div>

    <script>
        // Load raw transaction data from Local Storage
        let payments = JSON.parse(localStorage.getItem('payments')) || [];
        
        // --- Transaction Type Groupings (UPDATED) ---
        // New Consolidated Expense Keys 
        const newExpenseKeys = ['GeneralExpense', 'LokendraExpense', 'VikashExpense'];

        // Old detailed Expense Types (Used for backward compatibility with old data)
        const oldExpenseTypes = ['General Expense', 'Lokendra Expense', 'Vikash Expense', 'Expenses']; 
        
        // UPDATED: SWEETS CASH Group
        // New keys added: LokendraCash, VikashCash
        const sweetsCashTypes = ['Cashier', 'Lokendra ID', 'Vikash ID', 'LokendraCash', 'VikashCash', 'SweetsCash']; 
        
        // UPDATED: SWEETS UPI Group
        // New keys added: LokendraUPI, VikashUPI
        const sweetsUpiTypes = ['Lokendra UPI', 'Vikash UPI', 'LokendraUPI', 'VikashUPI', 'SweetsUPI'];

        // UPDATED: RESTAURANT Group
        // New keys added: DubeyCash, NipulCash, DubeyUPI, NipulUPI
        const restTypes = {
            cash: ['Restaurant Cash', 'DubeyCash', 'NipulCash', 'RestCash'],
            upi: ['Restaurant UPI', 'DubeyUPI', 'NipulUPI', 'RestUPI']
        };

        // ORDER UPI Group: General UPI + Bank + Card
        const orderUpiTypes = ['UPI', 'Bank', 'Card', 'OrderUPI'];

        // ORDER CASH Group: General Cash
        const orderCashTypes = ['Cash', 'OrderCash'];

        // All Consolidated Summary Keys (Income + Expenses) - UPDATED TO INCLUDE NEW KEYS
        const consolidatedKeys = [
            'OrderCash', 'OrderUPI', 
            'SweetsCash', 'SweetsUPI', // The final two columns for sweets
            'LokendraCash', 'LokendraUPI', 'VikashCash', 'VikashUPI', // New input keys for sweets
            'RestCash', 'RestUPI', // The final two columns for rest
            'DubeyCash', 'DubeyUPI', 'NipulCash', 'NipulUPI', // New input keys for rest
            ...newExpenseKeys
        ]; 

        // List of all transaction types for the dropdown in the EDIT MODAL - UPDATED
        const allTypes = [
            // Current input keys
            'OrderCash', 'OrderUPI', 
            'LokendraCash', 'LokendraUPI', 'VikashCash', 'VikashUPI',
            'SweetsCash', 'SweetsUPI', // Old types kept for manual entry/edit if needed
            'DubeyCash', 'DubeyUPI', 'NipulCash', 'NipulUPI',
            'RestCash', 'RestUPI', // Old types kept for manual entry/edit if needed
            
            // Old keys used for backward compatibility in mapping logic
            'Cash', 'Card', 'UPI', 'Bank', 
            'Restaurant Cash', 'Restaurant UPI', 
            'Lokendra UPI', 'Vikash UPI', 
            'Cashier', 'Lokendra ID', 'Vikash ID', 
            
            // Expense Keys
            'GeneralExpense', 'Lokendra Expense', 'Vikash Expense', 'Expenses'
        ];
        // ------------------------------------

        // Utility function for Indian rupee formatting
        const format = (amount) => `‚Çπ ${amount.toLocaleString('en-IN', { minimumFractionDigits: 2 })}`;

        document.addEventListener('DOMContentLoaded', () => {
            setupFilters(); 
            renderSummary();
            document.getElementById('date').valueAsDate = new Date();
            document.getElementById('payment-form').addEventListener('submit', addPayment);
        });
        
        // ====================================
        // FILTER LOGIC
        // ====================================
        function setupFilters() {
            const monthFilter = document.getElementById('month-filter');
            const yearFilter = document.getElementById('year-filter');
            
            // 1. Setup Months
            const monthNames = [
                "01 - January", "02 - February", "03 - March", "04 - April", "05 - May", 
                "06 - June", "07 - July", "08 - August", "09 - September", "10 - October", 
                "11 - November", "12 - December"
            ];
            monthNames.forEach((name, index) => {
                const option = new Option(name, String(index + 1).padStart(2, '0'));
                monthFilter.add(option);
            });

            // 2. Setup Years (from 2023 to next year)
            const currentYear = new Date().getFullYear();
            const minYear = 2023; 
            for (let y = currentYear + 1; y >= minYear; y--) {
                const option = new Option(y, y);
                yearFilter.add(option);
            }
            
            // 3. Set Defaults to current month/year
            const currentMonth = String(new Date().getMonth() + 1).padStart(2, '0');
            monthFilter.value = currentMonth;
            yearFilter.value = currentYear;
        }

        // ====================================
        // CRUD LOGIC
        // ====================================
        function addPayment(e) {
            e.preventDefault();

            const date = document.getElementById('date').value;
            const type = document.getElementById('type').value; 
            const amountInput = document.getElementById('amount').value;
            const details = document.getElementById('details').value;
            
            if (!date) {
                alert('Date is mandatory.');
                return;
            }
            
            const amount = amountInput ? parseFloat(amountInput) : 0;
            
            if (isNaN(amount) || amount === 0) {
                 if (!confirm('Warning: Amount is 0 or invalid. Do you want to add this entry anyway (e.g., as a placeholder)?')) {
                    return;
                }
            }
            
            // Check if type is one of the consolidated keys or new input keys
            if (consolidatedKeys.includes(type) === false) {
                alert('Please select a valid Transaction Type.');
                return;
            }

            const newPayment = {
                date,
                type: type || 'OrderCash', 
                amount: amount || 0,
                details,
                id: Date.now() + Math.floor(Math.random() * 1000) 
            };

            payments.push(newPayment);
            savePayments();
            renderSummary();

            document.getElementById('amount').value = '';
            document.getElementById('details').value = '';
            document.getElementById('type').value = 'OrderCash'; 
        }

        function savePayments() {
            localStorage.setItem('payments', JSON.stringify(payments));
        }
        
        function deleteDailyEntries(dateKey) {
            if (!confirm(`Are you sure you want to delete ALL summary entries for the date: ${new Date(dateKey).toLocaleDateString('en-IN')}? This action cannot be undone.`)) {
                return;
            }
            
            payments = payments.filter(payment => payment.date !== dateKey);
            
            savePayments();
            renderSummary();
        }
        
        function openEditModal(dateKey) {
            const dateDisplay = new Date(dateKey).toLocaleDateString('en-IN');
            document.getElementById('modal-date-title').textContent = dateDisplay;
            document.getElementById('editModal').style.display = 'flex';
            
            const entriesToEdit = payments.filter(p => p.date === dateKey);
            const editListBody = document.getElementById('edit-list-body');
            editListBody.innerHTML = '';

            entriesToEdit.forEach(entry => {
                const row = editListBody.insertRow();
                row.id = `edit-row-${entry.id}`;
                
                // 1. Type (Dropdown)
                const typeCell = row.insertCell(0);
                const typeSelect = document.createElement('select');
                typeSelect.id = `type-${entry.id}`;
                
                // Use the comprehensive list of all types for editing
                const fullOptions = [...allTypes];
                fullOptions.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    if (type === entry.type) {
                        option.selected = true;
                    }
                    typeSelect.appendChild(option);
                });
                typeCell.appendChild(typeSelect);

                // 2. Amount (Input)
                const amountCell = row.insertCell(1);
                const amountInput = document.createElement('input');
                amountInput.type = 'number';
                amountInput.step = '0.01';
                amountInput.value = entry.amount;
                amountInput.id = `amount-${entry.id}`;
                amountCell.appendChild(amountInput);

                // 3. Details (Input)
                const detailsCell = row.insertCell(2);
                const detailsInput = document.createElement('input');
                detailsInput.type = 'text';
                detailsInput.value = entry.details;
                detailsInput.id = `details-${entry.id}`;
                detailsCell.appendChild(detailsInput);

                // 4. Action (Save/Delete Button)
                const actionCell = row.insertCell(3);
                
                const saveButton = document.createElement('button');
                saveButton.textContent = 'Save';
                saveButton.className = 'save-edit-btn edit-btn';
                saveButton.onclick = () => saveIndividualEdit(entry.id);
                actionCell.appendChild(saveButton);
                
                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete';
                deleteButton.className = 'delete-btn';
                deleteButton.onclick = () => deleteIndividualEntry(entry.id, dateKey);
                actionCell.appendChild(deleteButton);
            });
        }
        
        function saveIndividualEdit(id) {
            const index = payments.findIndex(p => p.id === id);
            
            if (index === -1) {
                alert('Entry not found!');
                return;
            }

            const newAmount = parseFloat(document.getElementById(`amount-${id}`).value);
            const newType = document.getElementById(`type-${id}`).value;
            const newDetails = document.getElementById(`details-${id}`).value;
            
            if (isNaN(newAmount) || newAmount < 0) {
                 if (!confirm('Warning: Amount is invalid or negative. Continue saving?')) {
                    return;
                }
            }

            payments[index].type = newType;
            payments[index].amount = newAmount;
            payments[index].details = newDetails;
            
            savePayments();
            alert('Entry Saved!');
            openEditModal(payments[index].date); 
        }

        function deleteIndividualEntry(id, dateKey) {
            if (!confirm('Are you sure you want to delete this single transaction?')) {
                return;
            }

            payments = payments.filter(p => p.id !== id);
            savePayments();
            
            const remainingEntries = payments.filter(p => p.date === dateKey);
            
            if (remainingEntries.length === 0) {
                closeModal();
                renderSummary();
            } else {
                openEditModal(dateKey);
            }
        }

        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
        }


        // ====================================
        // IMPORT / EXPORT FUNCTIONS
        // ====================================
        function exportData() {
            if (payments.length === 0) {
                alert("No data to export!");
                return;
            }

            const header = ["id", "date", "type", "amount", "details"];
            
            const csvData = payments.map(p => 
                [
                    p.id,
                    p.date,
                    `"${p.type.replace(/"/g, '""')}"`, 
                    p.amount,
                    `"${p.details ? p.details.replace(/"/g, '""') : ''}"`
                ].join(',')
            );

            const csvContent = [header.join(','), ...csvData].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            
            const date = new Date().toISOString().slice(0, 10);
            link.setAttribute("href", URL.createObjectURL(blob));
            link.setAttribute("download", `monthly_summary_data_${date}.csv`);
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!confirm("Warning: Importing data will replace all existing entries in the tracker. Proceed?")) {
                event.target.value = null; 
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n').filter(line => line.trim() !== '');
                    
                    if (lines.length <= 1) {
                         alert("The CSV file is empty or contains only a header.");
                         return;
                    }

                    const newPayments = [];
                    for (let i = 1; i < lines.length; i++) {
                        const values = lines[i].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
                        
                        if (!values || values.length < 5) continue; 

                        const cleanValue = (val) => val.trim().replace(/^"|"$/g, '').replace(/""/g, '"');

                        const newEntry = {
                            id: parseInt(cleanValue(values[0])) || Date.now() + Math.floor(Math.random() * 1000), 
                            date: cleanValue(values[1]),
                            type: cleanValue(values[2]),
                            amount: parseFloat(cleanValue(values[3])),
                            details: cleanValue(values[4])
                        };

                        if (newEntry.date && !isNaN(newEntry.amount) && newEntry.type) {
                             newPayments.push(newEntry);
                        }
                    }

                    if (newPayments.length > 0) {
                        payments = newPayments;
                        savePayments();
                        renderSummary();
                        alert(`${newPayments.length} entries successfully imported!`);
                    } else {
                        alert("No valid entries found in the imported file.");
                    }

                } catch (error) {
                    console.error("Error importing file:", error);
                    alert("Error processing the CSV file. Please ensure it is correctly formatted.");
                } finally {
                    event.target.value = null; 
                }
            };
            reader.readAsText(file);
        }

        /**
         * Converts raw transaction data into a daily summary object.
         * @param {Array} data - The payments array (already filtered by month/year).
         */
        function calculateDailySummary(data) {
            const summaryMap = {}; 
            
            // The final columns in the summary table
            const finalIncomeKeys = ['OrderCash', 'OrderUPI', 'SweetsCash', 'SweetsUPI', 'RestCash', 'RestUPI'];

            // All types that should map to SweetsCash (including new LOKENDRA CASH/VIKASH CASH)
            const mapToSweetsCash = sweetsCashTypes; 
            // All types that should map to SweetsUPI (including new LOKENDRA UPI/VIKASH UPI)
            const mapToSweetsUpi = sweetsUpiTypes; 
            
            // All types that should map to RestCash (including new DUBEY CASH/NIPUL CASH)
            const mapToRestCash = restTypes.cash; 
            // All types that should map to RestUPI (including new DUBEY UPI/NIPUL UPI)
            const mapToRestUpi = restTypes.upi; 
            
            // All types that should map to OrderCash
            const mapToOrderCash = orderCashTypes;
            // All types that should map to OrderUPI
            const mapToOrderUpi = orderUpiTypes;


            data.forEach(payment => { 
                const dateKey = payment.date; 
                const amount = payment.amount || 0; 
                
                if (!summaryMap[dateKey]) {
                    summaryMap[dateKey] = { 
                        date: dateKey, 
                        OrderCash: 0, 
                        OrderUPI: 0, 
                        SweetsCash: 0, 
                        SweetsUPI: 0,  
                        RestCash: 0,  
                        RestUPI: 0, 
                        Expenses: 0, // Combined total for the table
                        GeneralExpense: 0, 
                        LokendraExpense: 0, 
                        VikashExpense: 0 
                    };
                }
                const summary = summaryMap[dateKey];
                
                const isNewExpense = newExpenseKeys.includes(payment.type);
                const isOldExpense = oldExpenseTypes.includes(payment.type);

                // --- Expense Mapping ---
                if (isNewExpense) {
                    summary[payment.type] += amount;
                    summary.Expenses += amount;
                } else if (isOldExpense) {
                    let mapToKey = 'GeneralExpense'; 
                    if (payment.type === 'Lokendra Expense') mapToKey = 'LokendraExpense';
                    if (payment.type === 'Vikash Expense') mapToKey = 'VikashExpense';
                    
                    summary[mapToKey] += amount;
                    summary.Expenses += amount;
                } 
                // --- Income Mapping (UPDATED LOGIC) ---
                else if (mapToOrderCash.includes(payment.type)) {
                    summary.OrderCash += amount;
                } else if (mapToOrderUpi.includes(payment.type)) {
                    summary.OrderUPI += amount;
                } else if (mapToSweetsCash.includes(payment.type)) {
                    summary.SweetsCash += amount;
                } else if (mapToSweetsUpi.includes(payment.type)) {
                    summary.SweetsUPI += amount;
                } else if (mapToRestCash.includes(payment.type)) {
                    summary.RestCash += amount;
                } else if (mapToRestUpi.includes(payment.type)) {
                    summary.RestUPI += amount;
                } else {
                    // Fallback for any unmapped type (e.g., if OrderUPI/Cash was accidentally excluded from groups)
                    // We assume it might be a general UPI entry if it reaches here and is an income type.
                    if (finalIncomeKeys.includes(payment.type)) {
                         summary[payment.type] += amount; // This handles the case where someone manually chose 'SweetsCash'
                    } else {
                         summary.OrderUPI += amount; // Default Fallback (safer than throwing away the amount)
                    }
                }
            });

            const summaryArray = Object.values(summaryMap);
            summaryArray.sort((a, b) => new Date(a.date) - new Date(b.date));
            return summaryArray;
        }

        /**
         * Renders the daily summary table and global totals.
         */
        function renderSummary() {
            const summaryTableBody = document.querySelector('#summary-table tbody');
            summaryTableBody.innerHTML = '';
            
            // Apply Month/Year Filter
            const selectedMonth = document.getElementById('month-filter').value;
            const selectedYear = document.getElementById('year-filter').value;
            
            const filteredPayments = payments.filter(p => {
                const dateParts = p.date.split('-'); 
                const year = dateParts[0];
                const month = dateParts[1];
                
                return year === selectedYear && month === selectedMonth;
            });
            
            const dailySummary = calculateDailySummary(filteredPayments); 

            // Resetting totals
            let totalOrderCash = 0;
            let totalOrderUPI = 0;
            let totalSweetsCash = 0; 
            let totalSweetsUPI = 0;  
            let totalRestCash = 0; 
            let totalRestUPI = 0; 
            
            let totalCombinedExpenses = 0; 
            
            let grandTotalIncome = 0;

            dailySummary.forEach(day => {
                const row = summaryTableBody.insertRow();
                let cellIndex = 0;
                
                // 1. DATE
                row.insertCell(cellIndex++).textContent = new Date(day.date).toLocaleDateString('en-IN');
                
                // 2. ORDER CASH
                const orderCashCell = row.insertCell(cellIndex++);
                orderCashCell.textContent = format(day.OrderCash);
                orderCashCell.classList.add('income-cell', 'order-cash-cell');
                totalOrderCash += day.OrderCash;

                // 3. ORDER UPI
                const orderUpiCell = row.insertCell(cellIndex++);
                orderUpiCell.textContent = format(day.OrderUPI);
                orderUpiCell.classList.add('income-cell', 'order-upi-cell');
                totalOrderUPI += day.OrderUPI;
                
                // 4. SWEETS CASH
                const sweetsCashCell = row.insertCell(cellIndex++);
                sweetsCashCell.textContent = format(day.SweetsCash);
                sweetsCashCell.classList.add('income-cell', 'sweets-cash-cell');
                totalSweetsCash += day.SweetsCash;

                // 5. SWEETS UPI
                const sweetsUpiCell = row.insertCell(cellIndex++);
                sweetsUpiCell.textContent = format(day.SweetsUPI);
                sweetsUpiCell.classList.add('income-cell', 'sweets-upi-cell');
                totalSweetsUPI += day.SweetsUPI;
                
                // 6. REST CASH
                const restCashCell = row.insertCell(cellIndex++);
                restCashCell.textContent = format(day.RestCash);
                restCashCell.classList.add('income-cell', 'rest-cash-cell');
                totalRestCash += day.RestCash;

                // 7. REST UPI
                const restUpiCell = row.insertCell(cellIndex++);
                restUpiCell.textContent = format(day.RestUPI);
                restUpiCell.classList.add('income-cell', 'rest-upi-cell');
                totalRestUPI += day.RestUPI;
                
                // 8. TOTAL EXPENSES (Combined total from summary.Expenses)
                const expensesCell = row.insertCell(cellIndex++);
                expensesCell.textContent = format(day.Expenses);
                expensesCell.classList.add('expense-cell');
                
                // Update Combined Expense Total Counter
                totalCombinedExpenses += day.Expenses; 

                
                // 9. ACTION 
                const actionCell = row.insertCell(cellIndex++);
                actionCell.classList.add('action-btns');
                
                const editButton = document.createElement('button');
                editButton.textContent = 'Edit üìù';
                editButton.className = 'edit-btn';
                editButton.onclick = () => openEditModal(day.date); 
                
                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete üóëÔ∏è';
                deleteButton.className = 'delete-btn';
                deleteButton.onclick = () => deleteDailyEntries(day.date); 
                
                actionCell.appendChild(editButton);
                actionCell.appendChild(deleteButton);

                const separatorRow = summaryTableBody.insertRow();
                const separatorCell = separatorRow.insertCell(0);
                separatorCell.colSpan = 9; 
                separatorCell.innerHTML = '<hr class="date-separator">';
                separatorCell.style.padding = '0';
            });
            
            // Calculate Grand Total Income
            grandTotalIncome = totalOrderCash + totalOrderUPI + totalSweetsCash + totalSweetsUPI + totalRestCash + totalRestUPI; 

            // --- Update Global Totals in Top Section ---
            document.getElementById('grand-total').textContent = format(grandTotalIncome);
            document.getElementById('total-order-cash').textContent = format(totalOrderCash);
            document.getElementById('total-order-upi').textContent = format(totalOrderUPI);
            document.getElementById('total-sweets-cash').textContent = format(totalSweetsCash); 
            document.getElementById('total-sweets-upi').textContent = format(totalSweetsUPI);   
            document.getElementById('total-rest-cash').textContent = format(totalRestCash); 
            document.getElementById('total-rest-upi').textContent = format(totalRestUPI);   
            
            // Single Combined Expense Total Display
            document.getElementById('total-combined-expenses').textContent = format(totalCombinedExpenses);


            // Add Final Total Row at the bottom of the table
            if (dailySummary.length > 0) {
                 const totalRow = summaryTableBody.insertRow();
                 totalRow.classList.add('row-total');
                 
                 totalRow.insertCell(0).textContent = '**ORDER SUM**'; 
                 totalRow.insertCell(1).textContent = format(totalOrderCash);
                 totalRow.insertCell(2).textContent = format(totalOrderUPI);
                 totalRow.insertCell(3).textContent = format(totalSweetsCash); 
                 totalRow.insertCell(4).textContent = format(totalSweetsUPI);   
                 totalRow.insertCell(5).textContent = format(totalRestCash);  
                 totalRow.insertCell(6).textContent = format(totalRestUPI);   
                 totalRow.insertCell(7).textContent = format(totalCombinedExpenses); 
                 totalRow.insertCell(8).textContent = ''; 
                 
                 for(let i=1; i<=6; i++) { 
                     totalRow.cells[i].classList.add('income-cell');
                 }
                 totalRow.cells[7].classList.add('expense-cell');
            }
        }
    </script>

</body>
</html>